<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json">
  <script src="https://unpkg.com/feather-icons"></script>
  <!-- Supabase SDK zuerst laden -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <title>Lilly • Web App</title>
  <style>
    :root {
      --bg: white;
      --text: black;
      --muted: #555;
      --accent: #3a6ff8;
      --radius: 14px;
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      --container: 1100px;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header-Bereich mit Emoji und Zahnrad */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      font-size: 1.6rem;
    }

    .emoji {
      font-size: 2rem;
      cursor: default;
      user-select: none;
      margin-top: 5px;
    }


    /* Willkommensnachricht */
    .welcome {
      text-align: center;
      margin-top: 20px;
    }

    .welcome h1 {
      font-size: clamp(2.6rem, 3vw, 2rem);
      margin: 0;
      font-weight: 600;
      margin: 10px;
      margin-bottom: 100px;
      color: black;
    }

    h2 {
      width: min(100%, var(--container));
      margin: 40px auto 10px auto; /* richtet sich an der Grid-Breite aus */
      padding-left: 24px; /* optische Einheit mit main-Padding */
      font-size: clamp(1.5rem, 3vw, 2rem);
      font-weight: 600;
      color: black;
      text-align: left;
    }

    /* Kartenübersicht */
    main {
      flex: 1;
      display: block;          /* kein zentriertes Flex mehr */
      padding: 0 24px 40px;    /* bündig mit h2 */
    }

    .grid {
      width: min(100%, var(--container));
      margin: 0 auto;           /* mittig auf der Seite */
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
    }

    /* Erweiterbare Kartenfunktion */
    .card {
      position: relative;
      background: white;
      border: 2px solid #000;
      padding: 18px;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .card.expanded {
      background: white;
    }

    /* Versteckter Bereich */
    .card-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    /* Sichtbar, wenn Karte aktiv ist */
    .card.expanded .card-content {
      max-height: 300px; /* oder auto, aber das animiert unschön */
    }

    /* Optional: sanfte Innenabstände */
    .card-content p {
      margin-top: 10px;
      font-size: 0.9rem;
      color: black;
    }

    /* Kürzel-Kreise oben rechts */
    .badge-circle {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: bold;
      color: #333;
      border: 2px solid rgba(0, 0, 0, 0.15);
      user-select: none;
    }

    /* Beispiel-Farben: pastellig, hell mit dunklerer Randidee */
    .badge-circle.jp {
      background: #dbeafe;        /* hellblau */
      border-color: #93c5fd;      /* etwas dunkler */
    }

    .badge-circle.pa {
      background: #fef9c3;        /* hellgelb */
      border-color: #fde047;      /* kräftiger gelbton */
    }
    
    .badge-circle.sm {
      background: #fce7f3;        /* rosa */
      border-color: #f9a8d4;      /* kräftiger rosa */
    }
    
    .badge-circle.vs {
      background: #dcfce7;        /* hellgrün */
      border-color: #86efac;      /* kräftiger grün */
    }

    .card h3 {
      margin: 0 0 6px 0;
      font-size: 1.1rem;
    }

    .card p {
      margin: 0;
      font-size: 0.95rem;
    }
    
    /* Button-Leiste unterhalb der ausgeklappten Inhalte */
    .card-buttons {
      display: none;
      margin-top: 16px;
      text-align: right;
      gap: 10px;
    }

    /* sichtbar, wenn Karte geöffnet */
    .card.expanded .card-buttons {
      display: flex;
      justify-content: flex-end;
    }

    /* allgemeines Button-Design */
    .card-buttons button {
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: white;
      transition: all 0.2s ease;
      padding: 6px 14px;
      user-select: none;
    }

    /* grün: annehmen */
    .card-buttons .accept {
      color: #15803d;
    }

    .card-buttons .accept:hover {
      background: #16a34a;
      color: white;
    }

    /* rot: ablehnen */
    .card-buttons .decline {
      color: #b91c1c;
    }

    .card-buttons .decline:hover {
      background: #dc2626;
      color: white;
    }
    
    #futureTitle {
      margin-top: 40px;
      text-align: left;
      font-weight: 600;
    }
    #futureTitle.visible {
      display: block;
      opacity: 1;
    }
    
    .edit {
      font-size: 1.6rem;
      margin-left: 12px;
      transition: transform 0.2s ease;
      cursor: pointer;
      user-select: none;
    }
    .edit:hover {
      transform: scale(1.2);
    }
    #adminPanel .grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    #adminPanel {
      max-width: var(--container);
      margin: 20px auto 40px auto;
      padding: 0 24px;
      display: none;
    }

    #adminPanel h2 {
      margin-bottom: 20px;
    }

    #adminPanel .user-card {
      background: white;
      border: 2px solid #000;
      border-radius: 12px;
      padding: 16px;
      font-size: 1rem;
      font-weight: 600;
      text-align: center;
      user-select: none;
    }

    #loginScreen {
      text-align: center;
      margin-top: 100px;
    }

    #loginScreen input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: center;
      width: 100px;
      font-size: 1.2rem;
      letter-spacing: 0.3em;
      font-weight: bold;
    }

    #loginScreen button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: white;
      color: black;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 10px;
      user-select: none;
    }

    #loginError {
      color: red;
      margin-top: 10px;
      display: none;
    }
      
      /* Neues minimalistisches PIN-Design (weiß/schwarz) */
      #loginScreen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 60px;
        min-height: 100vh;
        background: white;
        color: black;
        text-align: center;
        gap: 20px;
      }


      .pin-title {
        font-size: 2.2rem;
        font-weight: 600;
        margin: 0;
      }

      .pin-subtitle {
        color: black;
        font-size: 1rem;
        margin-bottom: 10px;
      }

      .pin-dots {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 20px;
      }

      .pin-dots span {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid black;
        background: transparent;
        transition: background 0.2s;
      }

      .pin-dots span.filled {
        background: black;
      }

      .pin-pad {
        display: grid;
        grid-template-columns: repeat(3, 70px);
        gap: 15px;
        justify-content: center;
      }

      .pin-pad button {
        width: 70px;
        height: 70px;
        font-size: 1.4rem;
        border-radius: 50%;
        border: 2px solid black;
        background: white;
        color: black;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .pin-pad button:hover {
        background: black;
        color: white;
      }

      .pin-pad .empty {
        visibility: hidden;
        pointer-events: none;
      }

      #loginError {
        color: red;
        margin-top: 20px;
        font-weight: 500;
        display: none;
      }
  </style>
</head>
<body>
  <header></header>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const dots = document.querySelectorAll('.pin-dots span');
    const padButtons = document.querySelectorAll('.pin-pad button');
    let pinInput = '';

    padButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.classList.contains('empty')) return;
        if (btn.classList.contains('del')) {
          pinInput = pinInput.slice(0, -1);
        } else {
          if (pinInput.length < 4) pinInput += btn.textContent;
        }

        dots.forEach((dot, idx) => {
          dot.classList.toggle('filled', idx < pinInput.length);
        });

        if (pinInput.length === 4) {
          document.getElementById('pinInput').value = pinInput;
          document.getElementById('loginBtn').click();
          pinInput = '';
          setTimeout(() => dots.forEach(d => d.classList.remove('filled')), 500);
        }
      });
    });
  });
  </script>
  
  <div id="loginScreen">
      <p class="pin-title">Hallo! Bitte gib deine PIN ein</p>
    <div class="pin-dots">
      <span></span><span></span><span></span><span></span>
    </div>
    <div class="pin-pad">
      <button>1</button><button>2</button><button>3</button>
      <button>4</button><button>5</button><button>6</button>
      <button>7</button><button>8</button><button>9</button>
      <button class="empty"></button><button>0</button><button class="del">⌫</button>
    </div>
    <p id="loginError">Ungültige PIN</p>
    <!-- Unsichtbares Input-Feld, bleibt für bestehende JS-Logik -->
    <input id="pinInput" type="hidden" maxlength="4" />
    <button id="loginBtn" style="display:none;"></button>
  </div>

  <div class="welcome" style="display:none;">
    <h1>Willkommen zurück!</h1>
  </div>

  <h2 style="display:none;">Ausstehend</h2>
  <template id="card-template">
    <article class="card">
      <div class="badge-circle"></div>
      <div class="card-header">
        <h3 class="card-date"></h3>
        <p class="card-info"></p>
      </div>
      <div class="card-body">
        <p class="card-desc"></p>
      </div>
      <div class="card-buttons">
        <button class="accept" title="Annehmen"><i data-feather="check-circle"></i></button>
        <button class="decline" title="Ablehnen"><i data-feather="x-circle"></i></button>
        <button class="withdraw" title="Zurückziehen"><i data-feather="corner-up-left"></i></button>
        <button class="edit-entry" title="Bearbeiten"><i data-feather="edit"></i></button>
      </div>
    </article>
  </template>
  <div id="noPendingMsg" style="text-align:center; opacity:0; transition:opacity 0.3s ease;">Keine ausstehenden Dienste</div>
  <main>
    <section class="grid" id="pendingGrid"></section>
  </main>
  
  <h2 id="futureTitle" style="opacity:0; display:none; transition:opacity 0.4s ease;">In Zukunft</h2>
  <main>
    <section class="grid" id="upcomingGrid"></section>
  </main>

  <div id="adminPanel" style="visibility:none;">
    <h2>Benutzerübersicht</h2>
    <section class="grid" id="userGrid"></section>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://uewrybgyaanhjoyqpmky.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVld3J5Ymd5YWFuaGpveXFwbWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjA2ODYsImV4cCI6MjA3NzMzNjY4Nn0.gTv68th-3S2hErX_Dp8RwjU3oZtQXLZFToLGUM5inT8"
    );

    document.addEventListener('DOMContentLoaded', () => {
      // Service Worker für Push-Benachrichtigungen registrieren
      if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker.register('sw.js').then(reg => {
          console.log('Service Worker registriert:', reg);
        }).catch(err => {
          console.error('Fehler bei der Service Worker Registrierung:', err);
        });
      }

      // Berechtigung für Push-Benachrichtigungen anfordern
      async function initPushNotifications() {
        if (Notification.permission !== 'granted') {
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') {
            console.log('Push-Benachrichtigungen deaktiviert');
            return;
          }
        }
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: 'BPI4n6n6n2zB3qv2n1NQqz3w8iM3w2fM6aZ2b4eG5g6d7f8g9h0j1k2l3m4n5o6p7' // <-- Ersetze durch deinen echten VAPID Public Key
        });
        console.log('Push Subscription:', JSON.stringify(subscription));
      }

      // Initialisiere Push Notifications nach erfolgreicher Registrierung
      initPushNotifications();
      const loginScreen = document.getElementById('loginScreen');
      const welcomeDiv = document.querySelector('.welcome');
      const welcomeTitle = document.querySelector('.welcome h1');
      const pendingGrid = document.getElementById('pendingGrid');
      const upcomingGrid = document.getElementById('upcomingGrid');
      const noPendingMsg = document.getElementById('noPendingMsg');
      const futureTitle = document.getElementById('futureTitle');
      const adminPanel = document.getElementById('adminPanel');
      const userGrid = document.getElementById('userGrid');
      const header = document.querySelector('header');

      // Feather icons initial replacement
      feather.replace();

      // Neue Template-basierte Card-Logik
      function createCard(item, roleParam) {
        const role = roleParam || (localStorage.getItem('role') || '').toLowerCase();
        const template = document.getElementById('card-template');
        const clone = template.content.cloneNode(true);
        const card = clone.querySelector('.card');

        // Badge
        clone.querySelector('.badge-circle').textContent = item.typ?.slice(0, 2).toLowerCase() || '';
        clone.querySelector('.card-date').textContent = item.datum || '';
        clone.querySelector('.card-info').textContent = `${item.typ || ''} ${item.bereich || ''}`;
        clone.querySelector('.card-desc').textContent = item.beschreibung || '';

        const acceptBtn = clone.querySelector('.accept');
        const declineBtn = clone.querySelector('.decline');
        const withdrawBtn = clone.querySelector('.withdraw');
        const editBtn = clone.querySelector('.edit-entry');

        if (role === 'admin') {
          acceptBtn.style.display = 'none';
          declineBtn.style.display = 'none';
        } else {
          withdrawBtn.style.display = 'none';
          editBtn.style.display = 'none';
        }

        card.addEventListener('click', (e) => {
          if (e.target.closest('.card-buttons')) return;
          card.classList.toggle('expanded');
        });

        acceptBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log('Annehmen:', item.id);
          updateStatus(item.id, 'approved');
        });

        declineBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log('Ablehnen:', item.id);
          card.style.opacity = '0.5';
          card.style.pointerEvents = 'none';
          updateStatus(item.id, 'pending');
        });

        withdrawBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log('Zurückziehen:', item.id);
          if (confirm('Diesen Eintrag wirklich löschen?')) {
            supabase
              .from('Database')
              .update({ status: 'deleted' })
              .eq('id', item.id)
              .then(({ error }) => {
                if (!error) {
                  card.style.opacity = '0.5';
                  card.style.pointerEvents = 'none';
                }
              });
          }
        });

        editBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log('Bearbeiten:', item.id);
          openAdminForm();
          document.getElementById('datumInput').value = item.datum || '';
          document.getElementById('typInput').value = item.typ || '';
          document.getElementById('bereichInput').value = item.bereich || '';
          document.getElementById('beschreibungInput').value = item.beschreibung || '';
          document.getElementById('saveNew').textContent = 'Änderungen speichern';
          document.getElementById('saveNew').dataset.editId = item.id;
        });

        feather.replace();
        return clone;
      }

      // Update status in Supabase and reload cards
      async function updateStatus(id, newStatus) {
        try {
          const { error } = await supabase
            .from('Database')
            .update({ status: newStatus })
            .eq('id', id);
          if (error) {
            return;
          }
          // Reload cards with current pin
          const pin = localStorage.getItem('pin');
          if (pin) {
            await loadCards(pin);
          }
        } catch (err) {
        }
      }

      // Load cards and sort by status
      async function loadCards(pin) {
        pendingGrid.innerHTML = '<p style="text-align:center;">Lade Daten...</p>';
        upcomingGrid.innerHTML = '';
        noPendingMsg.style.opacity = '0';
        futureTitle.style.opacity = '0';
        futureTitle.style.display = 'none';

        try {
          let data, error;
          // Prüfe Rolle aus localStorage
          if (localStorage.getItem('role') === 'admin') {
            // Admin sieht alle Container, die über connected_user_A mit seiner ID verbunden sind
            const result = await supabase
              .from('Database')
              .select('*')
              .eq('connected_user_A', pin);
            data = result.data;
            error = result.error;
          } else {
            // Standardabfrage für User
            const result = await supabase
              .from('Database')
              .select('*')
              .ilike('id', `${pin}_%`);
            data = result.data;
            error = result.error;
          }

          if (error) {
            pendingGrid.innerHTML = `<p style="color:red;">Fehler beim Laden: ${error.message}</p>`;
            return;
          }

          if (!data || data.length === 0) {
            pendingGrid.innerHTML = '<p style="text-align:center;">Keine Einträge gefunden.</p>';
            return;
          }

          // Clear grids
          pendingGrid.innerHTML = '';
          upcomingGrid.innerHTML = '';

          // Filter by status
          const pendingItems = data.filter(d => d.status === 'pending');
          const approvedItems = data.filter(d => d.status === 'approved');

          // Show pending or noPendingMsg
          if (pendingItems.length === 0) {
            noPendingMsg.style.opacity = '1';
          } else {
            noPendingMsg.style.opacity = '0';
            pendingItems.forEach(item => {
              const cardFrag = createCard(item);
              pendingGrid.appendChild(cardFrag);
            });
            feather.replace();
          }

          // Show approved in upcoming section
          if (approvedItems.length > 0) {
            futureTitle.style.display = 'block';
            setTimeout(() => { futureTitle.style.opacity = '1'; }, 50);
            approvedItems.forEach(item => {
              const cardFrag = createCard(item);
              upcomingGrid.appendChild(cardFrag);
            });
            feather.replace();
          } else {
            futureTitle.style.opacity = '0';
            futureTitle.style.display = 'none';
          }
        } catch (err) {
          pendingGrid.innerHTML = `<p style="color:red;">Fehler beim Laden: ${err.message}</p>`;
        }
      }

      // Add admin edit button and show admin panel
      function addAdminButton() {
        // Check if already added
        if (document.querySelector('.edit')) return;
        const editIcon = document.createElement('div');
        editIcon.className = 'edit';
        editIcon.title = 'Neuen Dienst hinzufügen';
        editIcon.innerHTML = '<i data-feather="edit-3"></i>';
        editIcon.onclick = openAdminForm;
        header.appendChild(editIcon);
        feather.replace();
        adminPanel.style.display = 'block';
        loadUsers();
      }

      // Load users for admin panel
      async function loadUsers() {
        userGrid.innerHTML = '<p style="text-align:center;">Lade Benutzer...</p>';
        try {
          const { data, error } = await supabase
            .from('Database')
            .select('UserName, id')
            .not('id', 'is', null);

          if (error) {
            userGrid.innerHTML = `<p style="color:red;">Fehler beim Laden: ${error.message}</p>`;
            return;
          }

          if (!data || data.length === 0) {
            userGrid.innerHTML = '<p style="text-align:center;">Keine Benutzer gefunden.</p>';
            return;
          }

          userGrid.innerHTML = '';
          // Unique users by id
          const uniqueUsers = [...new Map(data.map(u => [u.id, u])).values()];
          uniqueUsers.forEach(user => {
            const userCard = document.createElement('div');
            userCard.className = 'user-card';
            userCard.textContent = `${user.UserName} (${user.id})`;
            userGrid.appendChild(userCard);
          });
        } catch (err) {
          userGrid.innerHTML = `<p style="color:red;">Fehler beim Laden: ${err.message}</p>`;
        }
      }

      // Open admin form to add new service
      async function openAdminForm() {
        if(document.getElementById('adminForm')) return; // prevent multiple forms
        const formHtml = `
          <div id="adminForm" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:2px solid black; border-radius:10px; padding:20px; z-index:1000; max-width: 400px; width: 90%;">
            <h3>Neuen Dienst anlegen</h3>
            <label for="userSelect">User:</label>
            <select id="userSelect" style="width:100%; padding:8px; margin-bottom:10px;"></select>
            <label for="datumInput">Datum:</label>
            <input id="datumInput" type="date" style="width:100%; padding:8px; margin-bottom:10px;" />
            <label for="typInput">Typ:</label>
            <input id="typInput" type="text" placeholder="Typ" style="width:100%; padding:8px; margin-bottom:10px;" />
            <label for="bereichInput">Bereich:</label>
            <input id="bereichInput" type="text" placeholder="Bereich" style="width:100%; padding:8px; margin-bottom:10px;" />
            <label for="beschreibungInput">Beschreibung:</label>
            <textarea id="beschreibungInput" placeholder="Beschreibung" style="width:100%; padding:8px; margin-bottom:10px;"></textarea>
            <div style="text-align:right;">
              <button id="saveNew" style="background:#3a6ff8; color:white; border:none; border-radius:8px; padding:8px 16px; cursor:pointer; user-select:none;">Speichern</button>
              <button id="cancelNew" style="margin-left:10px; border:none; border-radius:8px; padding:8px 16px; cursor:pointer; user-select:none;">Abbrechen</button>
            </div>
          </div>
          <div id="adminFormBackdrop" style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:#00000088; z-index:999;"></div>
        `;
        document.body.insertAdjacentHTML('beforeend', formHtml);
        feather.replace();

        const { data: users, error } = await supabase
          .from('Database')
          .select('UserName, id')
          .not('id', 'is', null);

        // Nur Datensätze mit IDs, die genau 4 Zeichen lang sind
        const filteredUsers = (users || []).filter(u => u.id && u.id.length === 4);

        const userSelect = document.getElementById('userSelect');
        if (filteredUsers) {
          const uniqueUsers = [...new Map(filteredUsers.map(u => [u.id, u])).values()];
          uniqueUsers.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.textContent = `${u.UserName} (${u.id})`;
            userSelect.appendChild(opt);
          });
        }

        document.getElementById('cancelNew').onclick = () => {
          document.getElementById('adminForm').remove();
          document.getElementById('adminFormBackdrop').remove();
        };
        document.getElementById('adminFormBackdrop').onclick = () => {
          document.getElementById('adminForm').remove();
          document.getElementById('adminFormBackdrop').remove();
        };

        document.getElementById('saveNew').onclick = async () => {
          const userId = userSelect.value;
          const datum = document.getElementById('datumInput').value;
          const typ = document.getElementById('typInput').value.trim();
          const bereich = document.getElementById('bereichInput').value.trim();
          const beschreibung = document.getElementById('beschreibungInput').value.trim();

          if (!userId || !datum || !typ || !bereich || !beschreibung) {
            return;
          }

          const saveButton = document.getElementById('saveNew');
          if (saveButton.textContent === 'Änderungen speichern' && saveButton.dataset.editId) {
            // Bearbeitungsmodus: bestehenden Datensatz aktualisieren
            const { error } = await supabase
              .from('Database')
              .update({ datum, typ, bereich, beschreibung })
              .eq('id', saveButton.dataset.editId);
            if (error) {
              return;
            }
            document.getElementById('adminForm').remove();
            document.getElementById('adminFormBackdrop').remove();
            const currentPin = localStorage.getItem('id');
            if (currentPin) await loadCards(currentPin);
          } else {
            // Neuer Eintrag
            // Lade Namen des Erstellers anhand der PIN (localStorage id)
            const creatorPin = localStorage.getItem('id');
            let creatorName = 'Unbekannt';
            const { data: creatorData, error: creatorError } = await supabase
              .from('Database')
              .select('UserName')
              .eq('id', creatorPin)
              .single();
            if (!creatorError && creatorData && creatorData.UserName) {
              creatorName = creatorData.UserName;
            }
            const randomPart = Math.floor(100000 + Math.random() * 900000);
            const id = `${userId}_${randomPart}`;
            const { error } = await supabase
              .from('Database')
              .insert([{ id, datum, typ, bereich, beschreibung, connected_user_A: localStorage.getItem('id'), UserName: creatorName, status: 'pending' }]);
            if (error) {
              return;
            }
            document.getElementById('adminForm').remove();
            document.getElementById('adminFormBackdrop').remove();
            const currentPin = localStorage.getItem('id');
            if (currentPin) await loadCards(currentPin);
          }
        };
      }

      // Login button event
      document.getElementById('loginBtn').addEventListener('click', async () => {
        const pinInput = document.getElementById('pinInput');
        const pin = pinInput.value.trim();
        const loginError = document.getElementById('loginError');

        if (pin.length !== 4) {
          loginError.style.display = 'block';
          return;
        }

        loginError.style.display = 'none';

        const { data: userData, error } = await supabase
          .from('Database')
          .select('*')
          .eq('id', pin);

        if (error || !userData || userData.length === 0) {
          loginError.style.display = 'block';
          return;
        }

        loginError.style.display = 'none';
        loginScreen.style.display = 'none';
        welcomeDiv.style.display = 'block';

        const user = userData[0];
        localStorage.setItem('id', pin);
        welcomeTitle.textContent = `Willkommen zurück, ${user.UserName}!`;

        // Rolle im localStorage setzen
        if (user.role === 'admin') {
          localStorage.setItem('role', 'admin');
        } else {
          localStorage.setItem('role', 'user');
        }

        // Wenn admin -> Stift anzeigen und Admin Panel zeigen
        if (user.role === 'admin') {
          addAdminButton();
          // Titel "Ausstehend" zu "Übersicht" ändern
          const h2s = document.querySelectorAll('h2');
          if (h2s.length > 0) {
            h2s[0].textContent = 'Übersicht';
          }
        } else {
          adminPanel.style.display = 'none';
          const editIcon = document.querySelector('.edit');
          if(editIcon) editIcon.remove();
        }

        await loadCards(pin);

        // Echtzeit-Aktualisierung aktivieren (Supabase Realtime)
        let reloadTimeout;
        const channel = supabase
          .channel('live-updates')
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'Database' },
            async (payload) => {
              console.log('Live-Update:', payload);

              if (reloadTimeout) clearTimeout(reloadTimeout);
              reloadTimeout = setTimeout(async () => {
                const currentPin = localStorage.getItem('id');
                if (currentPin) {
                  await loadCards(currentPin);
                }
              }, 500);

              // --- Neue Logik: Benachrichtigung bei eigenen Containern ---
              const currentPin = localStorage.getItem('id');
              const newData = payload.new || {};
              const eventType = payload.eventType;

              if (newData.id && newData.id.startsWith(currentPin + '_')) {
                if (document.hidden && Notification.permission === 'granted') {
                  const registration = await navigator.serviceWorker.ready;

                  const title = eventType === 'UPDATE'
                    ? 'Dein Dienst wurde aktualisiert'
                    : eventType === 'INSERT'
                    ? 'Neuer Dienst erstellt'
                    : 'Ein Dienst wurde geändert';

                  const message = `Typ: ${newData.typ || 'Unbekannt'} • Status: ${newData.status || 'geändert'}`;

                  registration.showNotification(title, {
                    body: message,
                    icon: '/icon.png',
                    badge: '/badge.png',
                    data: { id: newData.id, status: newData.status },
                    actions: [
                      { action: 'open', title: 'App öffnen' }
                    ]
                  });
                }
              }
            }
          )
          .subscribe();
      });

      // Optional: allow Enter key on PIN input to trigger login
      document.getElementById('pinInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('loginBtn').click();
        }
      });
    });
  </script>

  <script>
    if (!window.featherInitialized) {
      feather.replace();
      window.featherInitialized = true;
    }
      
      // Beispiel: Manuell eine Notification auslösen (zum Testen)
      async function sendLocalNotification(title, message) {
        // Falls keine Erlaubnis erteilt wurde
        if (Notification.permission !== 'granted') {
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') return;
        }

        const registration = await navigator.serviceWorker.ready;

        registration.showNotification(title, {
          body: message,
          icon: '/icon.png',
          badge: '/badge.png',
          data: { link: window.location.href },
          actions: [
            { action: 'open', title: 'App öffnen' },
            { action: 'dismiss', title: 'Schließen' }
          ]
        });
      }

      // Beispielaufruf:
      document.addEventListener('keydown', (e) => {
        if (e.key === 'n') { // Wenn du "n" drückst, kommt eine Test-Nachricht
          sendLocalNotification('Testbenachrichtigung', 'Dies ist eine lokale Push-Nachricht.');
        }
      });
  </script>
</body>
</html>
