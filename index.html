<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/feather-icons"></script>
  <!-- Supabase SDK zuerst laden -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
      
      window.addEventListener("load", () => {
        const url = new URL(window.location.href);
        if (!url.searchParams.has("v")) {
          url.searchParams.set("v", Date.now());
          window.location.replace(url.toString());
        }
      });
    // Supabase initialisieren
    const supabase = window.supabase.createClient(
      "https://uewrybgyaanhjoyqpmky.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVld3J5Ymd5YWFuaGpveXFwbWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjA2ODYsImV4cCI6MjA3NzMzNjY4Nn0.gTv68th-3S2hErX_Dp8RwjU3oZtQXLZFToLGUM5inT8"
    );
    
    document.addEventListener('DOMContentLoaded', async () => {
      const section = document.querySelector('main section.grid');
      const upcomingSection = document.getElementById('upcoming');
      const pendingSection = section;
      section.innerHTML = '<p style="text-align:center;">Lade Daten...</p>';

      try {
        const { data, error } = await supabase
          .from('Database')
          .select('id, datum, typ, bereich, beschreibung, status, UserName, cardID, role')
          .eq('id', '1234');

        console.log("Supabase Daten:", data);
        if (Array.isArray(data)) {
          data.forEach((d, i) => console.log(`Datensatz ${i}:`, d));
          console.log("Spalten:", Object.keys(data[0] || {}));
        } else {
          console.warn("Keine Daten oder falsches Format:", data);
        }

        if (error) {
          section.innerHTML = `<p style="color:red;">Fehler beim Laden: ${error.message}</p>`;
          console.error("Supabase Fehler:", error);
          return;
        }

        if (!data || data.length === 0) {
          section.innerHTML = '<p style="text-align:center;">Keine Einträge gefunden.</p>';
          return;
        }

        // Willkommensnachricht aktualisieren
        if (data[0].UserName) {
          const welcomeTitle = document.querySelector('.welcome h1');
          welcomeTitle.textContent = `Willkommen zurück! ${data[0].UserName}`;
        }
        
        // Zweite Abfrage für Rollendefinition (z. B. 1234_role)
        const { data: roleData, error: roleError } = await supabase
          .from('Database')
          .select('role')
          .eq('id', '1234_role')
          .single();

        if (roleError) {
          console.warn("Keine Rollendefinition gefunden:", roleError.message);
        }

        // Wenn Rolle 'admin' -> Stift anzeigen
        if (roleData && roleData.role === 'admin') {
          const header = document.querySelector('header');
          const editIcon = document.createElement('div');
          editIcon.className = 'edit';
          editIcon.title = 'Admin-Modus';
          editIcon.innerHTML = '<i data-feather=\"edit-3\"></i>';
          editIcon.style.cursor = 'pointer';
          editIcon.onclick = toggleAdminView;
          header.appendChild(editIcon);
          feather.replace();
        }

        section.innerHTML = '';
        data.forEach(item => {
          const card = document.createElement('article');
          card.className = 'card';
          card.dataset.cardId = item.cardID;
          card.onclick = () => toggleCard(card);

          const badge = document.createElement('div');
          badge.className = 'badge-circle jp';
          badge.textContent = (item.bereich?.substring(0, 2) || 'NA').toUpperCase();
          card.appendChild(badge);

          const h3 = document.createElement('h3');
          h3.textContent = item.datum || '';
          card.appendChild(h3);

          const pInfo = document.createElement('p');
          pInfo.innerHTML = `<strong>${item.typ || ''}</strong> ${item.bereich || ''}`;
          card.appendChild(pInfo);

          const contentDiv = document.createElement('div');
          contentDiv.className = 'card-content';
          const beschrP = document.createElement('p');
          beschrP.innerHTML = '<br>' + (item.beschreibung || '');
          contentDiv.appendChild(beschrP);

          const btnBar = document.createElement('div');
          btnBar.className = 'card-buttons';
          const decline = document.createElement('button');
          decline.className = 'decline';
          decline.title = 'Ablehnen';
          decline.innerHTML = '<i data-feather="x"></i>';
          const accept = document.createElement('button');
          accept.className = 'accept';
          accept.title = 'Annehmen';
          accept.innerHTML = '<i data-feather="check"></i>';
          btnBar.appendChild(decline);
          btnBar.appendChild(accept);
          contentDiv.appendChild(btnBar);

          card.appendChild(contentDiv);
          // Statusprüfung und Verteilung auf die richtigen Bereiche
          const status = (item.status || '').toLowerCase();
          if (status === 'pending') {
            pendingSection.appendChild(card);
          } else if (status === 'approved') {
            upcomingSection.appendChild(card);
          } else {
            pendingSection.appendChild(card); // Fallback, falls kein Status gesetzt ist
          }
        });

        feather.replace();
        if (typeof updateVisibility === 'function') setTimeout(() => updateVisibility(), 150);
      } catch (err) {
        console.error("Allgemeiner Fehler:", err);
        section.innerHTML = '<p style="color:red;">Fehler beim Abrufen der Daten.</p>';
      }
    });
  </script>
  <title>Lilly • Web App</title>
  <style>
    :root {
      --bg: white;
      --text: black;
      --muted: #555;
      --accent: #3a6ff8;
      --radius: 14px;
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      --container: 1100px;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header-Bereich mit Emoji und Zahnrad */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      font-size: 1.6rem;
    }

    .emoji {
      font-size: 2rem;
      cursor: default;
      user-select: none;
      margin-top: 5px;
    }

    .settings {
      font-size: 1.6rem;
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s ease;
      margin-top: 5px;
    }
    .settings:hover {
      transform: rotate(30deg);
    }

    /* Willkommensnachricht */
    .welcome {
      text-align: center;
      margin-top: 20px;
    }

    .welcome h1 {
      font-size: clamp(2.6rem, 3vw, 2rem);
      margin: 0;
      font-weight: 600;
      margin: 10px;
      margin-bottom: 100px;
      color: black;
    }

    .welcome p {
      color: var(--muted);
      margin: 6px 0 30px 0;
      font-size: 1rem;
    }
      
      h2 {
        width: min(100%, var(--container));
        margin: 40px auto 10px auto; /* richtet sich an der Grid-Breite aus */
        padding-left: 24px; /* optische Einheit mit main-Padding */
        font-size: clamp(1.5rem, 3vw, 2rem);
        font-weight: 600;
        color: black;
        text-align: left;
      }

    /* Kartenübersicht */
    main {
      flex: 1;
      display: block;          /* kein zentriertes Flex mehr */
      padding: 0 24px 40px;    /* bündig mit h2 */
    }

    .grid {
      width: min(100%, var(--container));
      margin: 0 auto;           /* mittig auf der Seite */
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
    }

      /* Erweiterbare Kartenfunktion */
      .card {
        position: relative;
        background: white;
        border: 2px solid #000;
        padding: 18px;
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .card.expanded {
        background: white;
      }

      /* Versteckter Bereich */
      .card-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease;
      }

      /* Sichtbar, wenn Karte aktiv ist */
      .card.expanded .card-content {
        max-height: 300px; /* oder auto, aber das animiert unschön */
      }

      /* Optional: sanfte Innenabstände */
      .card-content p {
        margin-top: 10px;
        font-size: 0.9rem;
        color: black;
      }

      /* Kürzel-Kreise oben rechts */
      .badge-circle {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: bold;
        color: #333;
        border: 2px solid rgba(0, 0, 0, 0.15);
      }

      /* Beispiel-Farben: pastellig, hell mit dunklerer Randidee */
      .badge-circle.jp {
        background: #dbeafe;        /* hellblau */
        border-color: #93c5fd;      /* etwas dunkler */
      }

      .badge-circle.pa {
        background: #fef9c3;        /* hellgelb */
        border-color: #fde047;      /* kräftiger gelbton */
      }
      
      .badge-circle.sm {
        background: #fce7f3;        /* hellgelb */
        border-color: #f9a8d4;      /* kräftiger gelbton */
      }
      
      .badge-circle.vs {
        background: #dcfce7;        /* hellgelb */
        border-color: #86efac;      /* kräftiger gelbton */
      }

    .card h3 {
      margin: 0 0 6px 0;
      font-size: 1.1rem;
    }

    .card p {
      margin: 0;
      font-size: 0.95rem;
    }
      
      /* Button-Leiste unterhalb der ausgeklappten Inhalte */
      .card-buttons {
        display: none;
        margin-top: 16px;
        text-align: right;
        gap: 10px;
      }

      /* sichtbar, wenn Karte geöffnet */
      .card.expanded .card-buttons {
        display: flex;
        justify-content: flex-end;
      }

      /* allgemeines Button-Design */
      .card-buttons button {
        border: none;
        border-radius: 8px;
        font-size: 0.1rem;
        font-weight: 600;
        cursor: pointer;
        background: white;
        transition: all 0.2s ease;
      }

      /* grün: annehmen */
      .card-buttons .accept {
        color: #15803d;
      }

      .card-buttons .accept:hover {
        background: #16a34a;
        color: white;
      }

      /* rot: ablehnen */
      .card-buttons .decline {
        color: #b91c1c;
      }

      .card-buttons .decline:hover {
        background: #dc2626;
        color: white;
      }
      
      #futureTitle {
        margin-top: 40px;
        text-align: left;
        font-weight: 600;
      }
      #futureTitle.visible {
        display: block;
        opacity: 1;
      }
      
      .edit {
        font-size: 1.6rem;
        margin-left: 12px;
        transition: transform 0.2s ease;
      }
      .edit:hover {
        transform: scale(1.2);
      }
      #adminPanel .grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
      
      #userGrid {
        overflow: hidden;
        white-space: nowrap;
        position: relative;
        width: 100%;
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        padding: 1rem 0;
      }

      .user-tag {
        display: inline-block;
        background-color: #d9dadb;
        border-radius: 8px;
        padding: 0.4rem 0.8rem;
        font-weight: 500;
        font-size: 0.95rem;
        color: #000;
        margin-right: 0.6rem;
      }

      .user-tags-wrapper {
        display: flex;
        flex-wrap: wrap;
        animation: none;
      }

  </style>
</head>
<body>
  <header>
    <div class="emoji" data-feather="user"></div>
    <div class="settings" title="Einstellungen" onclick="alert('Einstellungen öffnen...')">
      <i data-feather="settings"></i>
    </div>
  </header>
  <div id="adminPanel">
    <div id="userGrid"></div>
  </div>
  <div class="welcome">
    <h1>Willkommen zurück!</h1>
  </div>
    <h2>Ausstehend</h2>
    <div id="noPendingMsg" style="text-align:center; opacity:0; transition:opacity 0.3s ease;">Keine ausstehenden Dienste</div>
<main>
      <section class="grid">
      </section>
      </main>
    
    <h2 id="futureTitle" style="opacity:0; display:none; transition:opacity 0.4s ease;">In Zukunft</h2>
    <br>
    <main>
    <section class="grid" id="upcoming"></section>
    </main>
    <script>
      function toggleCard(card) {
        card.classList.toggle('expanded');
      }

      const upcomingSection = document.getElementById('upcoming');
      const pendingSection = document.querySelector('main section.grid');
      const futureTitle = document.getElementById('futureTitle');
      const pendingTitle = document.querySelector('h2'); // "Ausstehend"

      // Sichtbarkeit mit echtem Layout-Verschieben
      function updateVisibility() {
        const hasPending = pendingSection.children.length > 0;
        const hasUpcoming = upcomingSection.children.length > 0;

        // --- Ausstehend ---
        // --- Ausstehend ---
        const noPendingMsg = document.getElementById('noPendingMsg');

        if (hasPending) {
          pendingTitle.style.display = 'block';
          pendingSection.style.display = 'grid';
          requestAnimationFrame(() => {
            pendingTitle.style.opacity = '1';
            pendingSection.style.opacity = '1';
          });
          noPendingMsg.style.opacity = '0';
          noPendingMsg.style.pointerEvents = 'none';
        } else {
          pendingTitle.style.display = 'block';
          pendingSection.style.display = 'none';
          pendingTitle.style.opacity = '1';
          noPendingMsg.style.opacity = '1';
          noPendingMsg.style.pointerEvents = 'auto';
        }

        // --- In Zukunft ---
        if (hasUpcoming) {
          futureTitle.style.display = 'block';
          upcomingSection.style.display = 'grid';
          requestAnimationFrame(() => {
            futureTitle.style.opacity = '1';
            upcomingSection.style.opacity = '1';
            upcomingSection.style.position = 'relative';
            upcomingSection.style.zIndex = '2';
          });
        } else {
          futureTitle.style.opacity = '0';
          upcomingSection.style.opacity = '0';
          setTimeout(() => {
            futureTitle.style.display = 'none';
            upcomingSection.style.display = 'none';
            upcomingSection.style.position = 'absolute';
            upcomingSection.style.zIndex = '0';
          }, 400);
        }
      }

      // Klicks abfangen
      document.addEventListener('click', async function(e) {
        const btn = e.target.closest('button');
        if (!btn) return;
        const card = btn.closest('.card');

        // --- ANNEHMEN ---
        if (btn.classList.contains('accept')) {
          card.classList.remove('expanded');
          card.style.opacity = '1';
          card.style.pointerEvents = 'auto';

          // "Annehmen"-Button entfernen
          const acceptBtn = card.querySelector('.accept');
          if (acceptBtn) acceptBtn.remove();

          // Supabase-Update für "approved"
          console.log("Statusänderung für Card-ID:", card.dataset.cardId);
          const updateResponse = await supabase
            .from('Database')
            .update({ status: 'approved' })
            .eq('cardID', card.dataset.cardId);
          console.log("Status aktualisiert auf 'approved':", updateResponse);

          // "Ablehnen" → Refresh-Symbol
          const declineBtn = card.querySelector('.decline');
          if (declineBtn) {
            declineBtn.innerHTML = '<i data-feather="refresh-ccw"></i>';
            declineBtn.title = 'Zurück nach oben';
            feather.replace();
          }

          upcomingSection.appendChild(card);

          card.animate(
            [{ transform: 'translateY(-10px)', opacity: 0 }, { transform: 'translateY(0)', opacity: 1 }],
            { duration: 300, easing: 'ease-out' }
          );

          updateVisibility();
        }

        // --- ABLEHNEN / REFRESH ---
        if (btn.classList.contains('decline')) {
          const parentSection = btn.closest('section');

          // Wenn Karte unten → zurück nach oben
          if (parentSection && parentSection.id === 'upcoming') {
            pendingSection.appendChild(card);

            // Buttons wiederherstellen
            const btnBar = card.querySelector('.card-buttons');
            const declineBtn = btnBar.querySelector('.decline');
            declineBtn.innerHTML = '<i data-feather="x"></i>';
            declineBtn.title = 'Ablehnen';

            // "Annehmen" wieder hinzufügen, falls fehlt
            const acceptMissing = !card.querySelector('.accept');
            if (acceptMissing) {
              const newAccept = document.createElement('button');
              newAccept.classList.add('accept');
              newAccept.title = 'Annehmen';
              newAccept.innerHTML = '<i data-feather="check"></i>';
              btnBar.appendChild(newAccept);
            }

            feather.replace();

            // Karte leicht ausgegraut anzeigen
            card.classList.remove('expanded');
            card.style.opacity = '0.6';

            card.animate(
              [{ transform: 'translateY(10px)', opacity: 0.5 }, { transform: 'translateY(0)', opacity: 0.6 }],
              { duration: 300, easing: 'ease-out' }
            );

          } else {
            // Falls oben: einfach zuklappen + grau machen
            card.classList.remove('expanded');
            card.style.opacity = '0.6';
          }

          // Supabase-Update für "pending"
          console.log("Statusänderung für Card-ID:", card.dataset.cardId);
          const updateResponse = await supabase
            .from('Database')
            .update({ status: 'pending' })
            .eq('cardID', card.dataset.cardId);
          console.log("Status aktualisiert auf 'pending':", updateResponse);

          updateVisibility();
        }

        e.stopPropagation();
      });

      feather.replace();
      
      async function toggleAdminView() {
        const mainContent = document.querySelector('main');
        const welcome = document.querySelector('.welcome');
        const headers = document.querySelectorAll('h2');
        const adminPanel = document.getElementById('adminPanel');

        const isVisible = adminPanel.style.display === 'block';
        if (isVisible) {
          // Admin-Ansicht schließen
          adminPanel.style.display = 'none';
          mainContent.style.display = 'block';
          headers.forEach(h => h.style.display = 'block');
          welcome.style.display = 'block';
          return;
        }

        // Normale Ansicht ausblenden
        mainContent.style.display = 'none';
        headers.forEach(h => h.style.display = 'none');
        welcome.style.display = 'none';

        // Admin-Panel zeigen
        adminPanel.style.display = 'block';
        const userGrid = document.getElementById('userGrid');
        userGrid.innerHTML = '<p>Lade Benutzer...</p>';

        // Benutzer abrufen
        const { data, error } = await supabase
          .from('Database')
          .select('id, UserName, role')
          .order('UserName');

        if (error) {
          userGrid.innerHTML = `<p style="color:red;">Fehler beim Laden der Benutzer: ${error.message}</p>`;
          return;
        }

        userGrid.innerHTML = '';
        userGrid.innerHTML = '';
        data.forEach(user => {
          const tag = document.createElement('span');
          tag.className = 'user-tag';
          tag.textContent = `${user.UserName}`;
          userGrid.appendChild(tag);
        });
      }
        
    </script>
    
    <script>
        if (!window.featherInitialized) {
          feather.replace();
          window.featherInitialized = true;
        }
    </script>
    
    
    
</body>
</html>
