<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lilly • Web App</title>

  <!-- Icons + Supabase -->
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Design -->
  <style>
      
      #logoutBtn i,
      #logoutBtn svg {
        color: #000;
        stroke: #000;
      }
      
    #skillDetail {
      transition: all 0.4s ease;
    }
    .shift-down {
      transition: transform 0.4s ease;
      transform: translateY(0);
    }
    .shift-down.active {
      transform: translateY(60px);
    }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root{
      --bg:#ffffff;            /* weiß, neutralisiert */
      --surface:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --accent:#3A6FF8;
      --accent-2:#111827;      /* dunkler Buttonstil wie im Login-Frame */
      --success:#16a34a;
      --danger:#dc2626;
      --radius-xl:28px;
      --radius-lg:20px;
      --radius-md:14px;
      --shadow-lg:0 18px 40px rgba(0,0,0,.08);
      --shadow:0 8px 24px rgba(0,0,0,.06);
      --container:980px;
    }

    a, a:visited, a:hover, a:active {
      color: #000;
      text-decoration: none;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0; height:100%;
      font-family:'Inter',system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:#fff; color:var(--text);
    }

    /* ========== LOGIN (Unicorn-Layout) ========== */
    #loginScreen{
      min-height:100dvh;
      display:block;
      padding:0;
    }
    .login-wrap{
      width:100%;
      height:100vh;
      display:flex;
      flex-direction:column;
      background:var(--surface);
      border-radius:0;
      overflow:hidden;
      box-shadow:none;
    }
    /* linkes Panel: Illustration */
    .login-hero{
      position:relative;
      background:#ffffff; /* weißer Hintergrund */
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 24px;
      isolation:isolate;
      height:40vh;
    }
    .login-hero img {
      width: min(340px, 50%);
      height: auto;
      object-fit: contain;
      margin: auto;
      display: block;
      margin-top: 200px;
    }
    /* Sprechblase */
    .speech-bubble {
      position: absolute;
      top: 45%;
      left: 60%;
      background: #fff;
      border-radius: 18px;
      padding: 10px 16px;
      font-size: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      color: var(--text);
      transform: translateY(-50%);
    }
    .speech-bubble::after {
      content: '';
      position: absolute;
      bottom: 10px;
      left: -10px;
      width: 0;
      height: 0;
      border: 10px solid transparent;
      border-right-color: #fff;
    }

    /* rechtes Panel: Formular */
    .login-form{
      padding:60px 42px;
      display:flex; flex-direction:column; justify-content:center;
      gap:18px; z-index:1;
      height:60vh;
    }
    .login-title{
      font-size:2.1rem; font-weight:800; letter-spacing:.2px; margin:0 0 4px;
    }
    .login-sub{ color:var(--muted); margin:0 0 18px; }

    .input{
      appearance:none; border:1.5px solid #e5e7eb; background:#fff;
      border-radius:14px; padding:14px 16px; font-size:1rem; outline:none;
      transition:border .2s, box-shadow .2s;
    }
    .input:focus {
      border-color: #000;
      box-shadow: 0 0 0 3px rgba(0,0,0,0.15);
    }

    .btn-primary{
      border:2px solid #000;
      background:black;
      color:white;
      cursor:pointer;
      border-radius:999px;
      padding:14px 18px;
      font-weight:700;
      box-shadow:none;
      transition:transform .12s ease, opacity .12s ease, box-shadow .2s;
    }
    .btn-primary:hover{
      background:#000;
      color:#fff;
      transform:none;
    }
    .login-hint{ color:var(--muted); font-size:.94rem; text-align:center; margin-top:6px; }
    .login-hint b{ color:var(--text); }

    #loginError{ color:var(--danger); font-weight:600; display:none; margin-top:4px; }

    /* Responsive Login */
    @media (max-width:900px){
      .login-wrap{
        flex-direction:column;
        width:100%;
        height:100vh;
        display:flex;
      }
      .login-hero{ min-height:0; height:40vh; }
      .login-hero::after{ height:80px; }
      .login-form{ padding:36px 22px 42px; height:60vh; }
    }

    /* ========== APP HEADER / MAIN (Your Tasks) ========== */
    header.app{
      display:none; /* erst nach Login sichtbar */
      position:sticky; top:0; z-index:20;
      background:var(--surface);
      box-shadow:var(--shadow);
      padding:18px 22px;
    }
    .app-row{
      width:min(100%, var(--container));
      margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:800; font-size:1.6rem;
    }
    .brand i{ color:var(--accent); }

    /* Searchbar */
    .searchbar{
      width:min(100%, var(--container));
      margin:12px auto 0;
      padding:10px 14px;
      background:#fff; border-radius:14px;
      box-shadow:0 1px 6px rgba(0,0,0,.05);
      display:flex; align-items:center; gap:10px;
    }
    .searchbar input{
      border:none; outline:none; flex:1; font-size:1rem; background:transparent; color:var(--text);
    }
    .searchbar i{ color:#9ca3af; }

    /* Sections */
    .app-section{
      width:min(100%, var(--container)); margin:24px auto;
      padding:0 16px;
    }
    .section-title{
      font-size:1.8rem; font-weight:800; margin:8px 0 12px;
      letter-spacing:.2px;
    }

    /* Card Grid im Task-Stil */
    .grid{
      display:grid; gap:18px;
      grid-template-columns:1fr;
    }
    @media (min-width:720px){
      .grid{ grid-template-columns:1fr 1fr; }
    }

    .task-card{
      position:relative;
      background:var(--surface);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px 18px 18px 18px;
      display:flex; gap:14px; align-items:center;
      cursor:pointer; transition:transform .12s ease, box-shadow .2s ease;
    }
    .task-card:hover{ transform:translateY(-2px); box-shadow:0 14px 32px rgba(0,0,0,.08); }

    .task-badge{
      flex:0 0 auto;
      background:#111827; color:#fff; font-weight:700;
      border-radius:10px; padding:8px 10px; min-width:42px; text-align:center;
    }
    .task-content{
      flex:1 1 auto;
    }
    .task-title{ margin:0; font-size:1.15rem; font-weight:800; }
    .task-sub{ margin:4px 0 0; color:var(--muted); font-size:.97rem; line-height:1.5; }

    .task-illustr{
      width:84px; height:84px; border-radius:18px; background:#f3f4f6;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .task-illustr img{ width:74px; height:auto; }

    /* Buttonsleiste in Karten (deine existierenden Aktionen) */
    .card-buttons{
      display:none; gap:10px; margin-top:12px; justify-content:flex-end;
    }
    .task-card.expanded .card-buttons{ display:flex; }
    .chip-btn{
      border:none; border-radius:10px; padding:8px 12px; background:#f3f4f6;
      font-weight:600; cursor:pointer; transition:background .2s,color .2s;
    }
    .chip-btn.accept:hover{ background:var(--success); color:#fff; }
    .chip-btn.decline:hover{ background:var(--danger); color:#fff; }

    /* Admin Panel clean */
    #adminPanel{
      display:none; width:min(100%,var(--container)); margin:26px auto 60px; padding:0 16px;
    }
    #adminPanel .grid{ grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
    .user-card{
      background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:14px; text-align:center; font-weight:600;
    }

    /* Utility */
    .hidden{display:none!important}

    /* Bell shake animation for notifications bell */
    @keyframes bellShake {
      0%, 100% { transform: rotate(0deg); }
      20% { transform: rotate(-15deg); }
      40% { transform: rotate(10deg); }
      60% { transform: rotate(-10deg); }
      80% { transform: rotate(5deg); }
    }
    .bell-shake {
      animation: bellShake 0.8s ease-in-out;
    }
    /* Fade-in effect for futureList updates */
    .fade-enter {
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .fade-enter-active {
      opacity: 1;
    }

    /* Ripple-Effekt beim Öffnen */
    @keyframes rippleExpand {
      0% {
        transform: scale(0.7);
        opacity: 0;
      }
      60% {
        transform: scale(1.05);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* sanftes Zusammenziehen beim Schließen */
    @keyframes rippleClose {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(0.9);
        opacity: 0;
      }
    }

    #skillDetail.ripple-open {
      animation: rippleExpand 0.4s ease forwards;
    }

    #skillDetail.ripple-close {
      animation: rippleClose 0.3s ease forwards;
    }
  </style>
</head>
<body>

  <!-- ========== LOGIN SCREEN ========== -->
  <section id="loginScreen" aria-label="Login">
    <div class="login-wrap">
      <div class="login-hero">
        <!-- Ersetz das Bild durch dein eigenes -->
        <img src="https://raw.githubusercontent.com/lillyapp/lillyapp/refs/heads/main/cat.png" alt="Katze Illustration" />
        <div class="speech-bubble" id="catSpeech">Willkommen zurück!</div>
      </div>
      <form class="login-form" onsubmit="return false;">
        <h1 class="login-title">Hallo! Schön, dass du da bist.</h1>

        <!-- Wir bleiben bei 4-stelliger PIN, stilistisch aber wie E-Mail-Feld -->
        <input id="pinInput" class="input" type="password" inputmode="numeric" maxlength="4" placeholder="4-stellige PIN" autocomplete="one-time-code" />
        <button id="loginBtn" class="btn-primary" type="button">Login</button>
        <div id="loginError">PIN ungültig oder nicht gefunden.</div>
      </form>
    </div>
  </section>

  <!-- ========== APP HEADER ========== -->
  <!-- Header removed per new design -->

  <!-- ========== MAIN APP SCREEN (Redesign) ========== -->
  <main id="appMain" class="hidden" role="main" style="min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:var(--bg);padding-bottom:42px;position:relative;">
    <!-- Logout Button oben rechts -->
    <button id="logoutBtn" type="button" aria-label="Logout" style="position:absolute;right:18px;top:18px;background:transparent;border:none;cursor:pointer;z-index:50;padding:4px;">
      <i data-feather="log-out"></i>
    </button>
    <!-- Avatar & Username -->
    <div style="display:flex;flex-direction:column;align-items:center;margin-top:36px;margin-bottom:32px;">
      <div style="width:96px;height:96px;border-radius:50%;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden;">
          <img src="" alt="Avatar" style="width:84px;height:84px;object-fit:cover;" />
      </div>
      <div id="userMainName" style="margin-top:18px;font-size:1.35rem;font-weight:700;letter-spacing:.1px;text-align:center;">Lilly</div>
    </div>
    <!-- Cards: Benachrichtigungen, Einstellungen & Tutorial -->
    <div class="scroll-gallery-wrapper">
      <div class="scroll-btn-bar">
        <button class="scroll-btn left" type="button"><i data-feather="chevron-left"></i></button>
        <button class="scroll-btn right" type="button"><i data-feather="chevron-right"></i></button>
      </div>
      <div
        class="scroll-gallery"
        style="
          display:flex;
          gap:18px;
          overflow-x:auto;
          overflow-y:hidden;
          scroll-snap-type:x mandatory;
          scroll-behavior:smooth;
          -webkit-overflow-scrolling:touch;
          padding: 0px 20px;
        "
      >
        <div id="notificationsCard"
          style="
            flex:0 0 auto;
            min-width:120px;
            max-width:180px;
            width:160px;
            background:#f3f4f6;
            border-radius:var(--radius-lg);
            margin-right:0;
            scroll-snap-align:center;
            box-sizing:border-box;
            padding:24px 18px;
            display:flex;
            flex-direction:column;
            align-items:flex-start;
            justify-content:center;
            cursor:pointer;
          "
        >
          <i data-feather="bell" style="color:#000;width:28px;height:28px;align-self:flex-start;margin-bottom:10px;"></i>
          <div style="font-weight:600;font-size:1.05rem;margin-top:18px;text-align:left;align-self:stretch;">Erinnerungen</div>
        </div>
        <div
          style="
            flex:0 0 auto;
            min-width:120px;
            max-width:180px;
            width:160px;
            background:#f3f4f6;
            border-radius:var(--radius-lg);
            margin-right:0;
            scroll-snap-align:center;
            box-sizing:border-box;
            padding:24px 18px;
            display:flex;
            flex-direction:column;
            align-items:flex-start;
            justify-content:center;
          "
        >
          <i data-feather="settings" style="color:#000;width:28px;height:28px;align-self:flex-start;margin-bottom:10px;"></i>
          <div style="font-weight:600;font-size:1.05rem;margin-top:18px;text-align:left;align-self:stretch;">Einstellungen</div>
        </div>
        <div
          style="
            flex:0 0 auto;
            min-width:120px;
            max-width:180px;
            width:160px;
            background:#f3f4f6;
            border-radius:var(--radius-lg);
            margin-right:0;
            scroll-snap-align:center;
            box-sizing:border-box;
            padding:24px 18px;
            display:flex;
            flex-direction:column;
            align-items:flex-start;
            justify-content:center;
          "
        >
          <i data-feather="book-open" style="color:#000;width:28px;height:28px;align-self:flex-start;margin-bottom:10px;"></i>
          <div style="font-weight:600;font-size:1.05rem;margin-top:18px;text-align:left;align-self:stretch;">Tutorial</div>
        </div>
      </div>
    </div>
    <!-- Skill Meter Section -->
    <section id="skillMeter" style="width:min(100%,var(--container));padding:20px;margin-top:8px;margin-bottom:30px;">
      <div class="skill-bars" style="display:flex;align-items:center;gap:20px;justify-content:space-between;">
        <i data-feather="tool" style="width:18px;height:18px;align-self:center;"></i>
        <div class="skill-bar" data-skill="fach" style="flex:1;height:16px;background:#e5e7eb;border-radius:8px;cursor:pointer;overflow:hidden;">
          <div class="fill" style="height:100%;width:0%;background:#3A6FF8;border-radius:8px;"></div>
        </div>
        <i data-feather="user" style="width:18px;height:18px;align-self:center;"></i>
        <div class="skill-bar" data-skill="pers" style="flex:1;height:16px;background:#e5e7eb;border-radius:8px;cursor:pointer;overflow:hidden;">
          <div class="fill" style="height:100%;width:0%;background:#16a34a;border-radius:8px;"></div>
        </div>
        <i data-feather="users" style="width:18px;height:18px;align-self:center;"></i>
        <div class="skill-bar" data-skill="sozial" style="flex:1;height:16px;background:#e5e7eb;border-radius:8px;cursor:pointer;overflow:hidden;">
          <div class="fill" style="height:100%;width:0%;background:#f59e0b;border-radius:8px;"></div>
        </div>
      </div>
      <div id="skillDetail" style="display:none;position:relative;background:#f3f4f6;border-radius:12px;padding:16px;margin-top:14px;">
        <div class="triangle" style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:10px solid #f3f4f6;"></div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <h3 id="skillTitle" style="margin:0;font-size:1.1rem;font-weight:700;">Kompetenz</h3>
          <div style="display:flex;align-items:center;gap:8px;">
            <i data-feather="zap" style="width:1.1rem;height:1.1rem;"></i>
            <div id="skillColorCircle" style="width:20px;height:20px;border-radius:50%;border:2px solid #000;box-shadow:0 0 4px rgba(0,0,0,0.1);background:#3A6FF8;cursor:pointer;"></div>
          </div>
        </div>
        <p id="skillText" style="margin-top:8px;color:var(--muted);line-height:1.5;font-size:0.95rem;"></p>
        <div id="colorPalette" style="display:none;position:absolute;bottom:20px;right:0;flex-direction:row;gap:6px;padding:6px;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:10;">
          <div class="color-option" data-color="#3A6FF8" style="width:20px;height:20px;border-radius:50%;background:#3A6FF8;cursor:pointer;"></div>
          <div class="color-option" data-color="#16a34a" style="width:20px;height:20px;border-radius:50%;background:#16a34a;cursor:pointer;"></div>
          <div class="color-option" data-color="#f59e0b" style="width:20px;height:20px;border-radius:50%;background:#f59e0b;cursor:pointer;"></div>
          <div class="color-option" data-color="#dc2626" style="width:20px;height:20px;border-radius:50%;background:#dc2626;cursor:pointer;"></div>
          <div class="color-option" data-color="#6366f1" style="width:20px;height:20px;border-radius:50%;background:#6366f1;cursor:pointer;"></div>
        </div>
      </div>
    </section>
    <!-- "In Zukunft" Section -->
    <section class="app-section" style="width:min(100%,var(--container));padding-left:20px;padding-right:20px;margin-top:0;">
      <div style="display:flex;align-items:center;justify-content:space-between;position:relative;">
        <h2 class="section-title" id="futureSectionTitle" style="font-size:1.4rem;margin-bottom:14px;margin-top:0;">In Zukunft</h2>
        <button id="addContainerBtn" style="position:absolute;right:0;top:38%;transform:translateY(-50%);background:none;border:none;padding:0;margin:0;cursor:pointer;">
          <i data-feather="plus" style="width:24px;height:24px;color:#000;"></i>
        </button>
        <button id="backButton" style="position:absolute;right:0;top:38%;transform:translateY(-50%);background:none;border:none;padding:0;margin:0;cursor:pointer;display:none;">
          <i data-feather="arrow-left" style="width:24px;height:24px;color:#000;"></i>
        </button>
      </div>
      <div id="futureList" style="display:flex;flex-direction:column;gap:12px;"></div>
    </section>
    <!-- Hinweis wenn keine Pending -->
    <p id="noPendingMsg" class="hidden" style="display:none!important; text-align:center; color:var(--muted);margin-top:24px;">Keine ausstehenden Aufgaben</p>
    <!-- Adminbereich (unverändert) -->
    <div id="adminPanel">
      <h2 class="section-title" style="margin-top:0;">Benutzerübersicht</h2>
      <section class="grid" id="userGrid"></section>
    </div>
  </main>

  <!-- Template für Karten (visuell im Task-Stil) -->
  <template id="card-template">
    <article class="task-card">
      <div class="task-badge">16</div>
      <div class="task-content">
        <h3 class="task-title"></h3>
        <p class="task-sub"></p>
        <div class="card-buttons">
          <button class="chip-btn accept" title="Annehmen"><i data-feather="check-circle"></i></button>
          <button class="chip-btn decline" title="Ablehnen"><i data-feather="x-circle"></i></button>
          <button class="chip-btn withdraw" title="Zurückziehen"><i data-feather="corner-up-left"></i></button>
          <button class="chip-btn edit-entry" title="Bearbeiten"><i data-feather="edit-3"></i></button>
        </div>
      </div>
      <div class="task-illustr">
        <!-- optional Illustration pro Typ -->
        <img alt="illustration" src="https://dummyimage.com/160x160/f3f4f6/aaaaaa.png&text=%F0%9F%90%BE" />
      </div>
    </article>
  </template>
  <!-- Template für "In Zukunft" List Card -->
  <template id="future-card-template">
    <div class="future-list-card" style="display:flex;align-items:center;justify-content:space-between;background:#fff;border-radius:18px;box-shadow:0 2px 12px rgba(0,0,0,0.05);padding:16px 18px;gap:12px;">
      <div style="display:flex;align-items:center;gap:14px;">
        <div style="background:#f3f4f6;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;">
          <i data-feather="feather" style="color:#3A6FF8;width:22px;height:22px;"></i>
        </div>
        <div>
          <div class="future-title" style="font-weight:600;font-size:1.07rem;"></div>
          <div class="future-date" style="color:var(--muted);font-size:.97rem;margin-top:2px;"></div>
        </div>
      </div>
      <div class="future-status" style="font-weight:700;font-size:1.1rem;"></div>
    </div>
  </template>

  <!-- ========== SCRIPT / FUNKTIONEN ========== -->
  <script>
    // ----- Inline SVG Avatars -----
    const profileSVGs = {
      // 1: Dog
      avatar01: `<img src="https://raw.githubusercontent.com/lillyapp/lillyapp/refs/heads/main/avatar01.png" style="width:100px; height:100px; position:center"/> `,
      // 2: Girl
      avatar02: `<img src="https://raw.githubusercontent.com/lillyapp/lillyapp/refs/heads/main/avatar02.png"style="width:100px; height:100px; position:center"/>`,
      // 3: Fox
      avatar03: `<img src="https://raw.githubusercontent.com/lillyapp/lillyapp/refs/heads/main/avatar03.png"style="width:100px; height:100px; position:center"/>`,
      // 4: Boy
      avatar04: `<img src="https://raw.githubusercontent.com/lillyapp/lillyapp/refs/heads/main/avatar04.png"style="width:100px; height:100px; position:center"/>`,
      
    };
    const supabase = window.supabase.createClient(
      "https://uewrybgyaanhjoyqpmky.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVld3J5Ymd5YWFuaGpveXFwbWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjA2ODYsImV4cCI6MjA3NzMzNjY4Nn0.gTv68th-3S2hErX_Dp8RwjU3oZtQXLZFToLGUM5inT8"
    );

    const loginScreen  = document.getElementById('loginScreen');
    const appHeader    = document.getElementById('appHeader');
    const appMain      = document.getElementById('appMain');
    const pendingGrid  = document.getElementById('pendingGrid');
    const upcomingGrid = document.getElementById('upcomingGrid');
    const noPendingMsg = document.getElementById('noPendingMsg');
    const adminPanel   = document.getElementById('adminPanel');
    const userGrid     = document.getElementById('userGrid');

    // ---------- Auto-Login & Initialisierung ----------
    (async function initLillyApp() {
      feather.replace();

      // 1. Feather Icons ersetzt (bereits oben)

      // 2. Prüfen auf lilly_pin-Cookie
      const match = document.cookie.match(/(?:^|; )lilly_pin=([^;]+)/);
      if (match && match[1]) {
        // 3. Wenn Cookie vorhanden: Auto-Login
        const savedPin = match[1];
        console.log("[AutoLogin] Gefundener Cookie-PIN:", savedPin);
        const {data:userData, error} = await supabase.from('Database').select('*').eq('id', savedPin).limit(1);
        if(!error && userData && userData.length > 0){
          const user = userData[0];
          localStorage.setItem('id', savedPin);
          localStorage.setItem('role', user.role || 'user');
          // Name & Avatar setzen
          const userMainName = document.getElementById('userMainName');
          if (userMainName && user.UserName) userMainName.textContent = user.UserName;
          const avatarContainer = document.querySelector('#appMain div[style*="width:96px"]');
          if (avatarContainer && user.user_profile_pic && profileSVGs[user.user_profile_pic]) {
            avatarContainer.innerHTML = profileSVGs[user.user_profile_pic];
          } else if (avatarContainer) {
            avatarContainer.innerHTML = profileSVGs['avatar01'];
          }
          // Farben aus Supabase holen & speichern
          let userColors = {};
          try {
            const { data: colorData, error: colorErr } = await supabase
              .from('Database')
              .select('color_f, color_p, color_s')
              .eq('id', savedPin)
              .single();
            userColors = {
              fach: (colorData && colorData.color_f) || '#3A6FF8',
              pers: (colorData && colorData.color_p) || '#16a34a',
              sozial: (colorData && colorData.color_s) || '#f59e0b'
            };
            localStorage.setItem('userColors', JSON.stringify(userColors));
          } catch (err) {
            userColors = {
              fach: '#3A6FF8',
              pers: '#16a34a',
              sozial: '#f59e0b'
            };
          }
          // SkillMeter-Balken Farben sofort anpassen
          const bars = document.querySelectorAll('#skillMeter .skill-bar .fill');
          bars.forEach(bar => {
            const skillBar = bar.parentElement && bar.parentElement.dataset ? bar.parentElement.dataset.skill : null;
            if (skillBar === 'fach') bar.style.background = userColors.fach || '#3A6FF8';
            if (skillBar === 'pers') bar.style.background = userColors.pers || '#16a34a';
            if (skillBar === 'sozial') bar.style.background = userColors.sozial || '#f59e0b';
          });
          // App-UI anzeigen, Login-Screen ausblenden
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('appMain').classList.remove('hidden');
          if((user.role||'user') === 'admin'){ addAdminButton(); }
          // Karten laden, Glockenüberwachung starten
          await loadCards(savedPin);
          monitorPendingStatus();
          // Notifications & Settings Toggle initialisieren (nur nach Login)
          setupNotificationsToggle();
          setupSettingsToggle();
        } else {
          // Kein gültiger User, Login anzeigen
          document.getElementById('loginScreen').style.display = 'block';
          document.getElementById('appMain').classList.add('hidden');
        }
      } else {
        // 4. Kein Cookie: Login-Screen anzeigen, App-UI ausblenden
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('appMain').classList.add('hidden');
      }
    })();

    // ---------- Karten-Renderer (Task-Stil) ----------
    function createCard(item, roleParam){
      const role = roleParam || (localStorage.getItem('role') || 'user').toLowerCase();
      const tpl = document.getElementById('card-template');
      const frag = tpl.content.cloneNode(true);
      const card = frag.querySelector('.task-card');

      // Badge: kleine Zahl, fallback 1
      frag.querySelector('.task-badge').textContent = (item.count || 1);

      // Titel/Unterzeile
      frag.querySelector('.task-title').textContent = item.typ || 'Ohne Typ';
      const details = [item.bereich, item.datum].filter(Boolean).join(' • ');
      frag.querySelector('.task-sub').textContent = item.beschreibung || details || 'Keine Beschreibung';

      // Buttons je nach Rolle
      const acceptBtn   = frag.querySelector('.accept');
      const declineBtn  = frag.querySelector('.decline');
      const withdrawBtn = frag.querySelector('.withdraw');
      const editBtn     = frag.querySelector('.edit-entry');

      if(role === 'admin'){ acceptBtn.style.display='none'; declineBtn.style.display='none'; }
      else { withdrawBtn.style.display='none'; editBtn.style.display='none'; }

      // expand/collapse: Buttons sichtbar machen
      card.addEventListener('click', (e)=>{
        if(e.target.closest('.card-buttons')) return;
        card.classList.toggle('expanded');
      });

      // Actions
      acceptBtn.addEventListener('click', (e)=>{ e.stopPropagation(); updateStatus(item.id,'approved'); });
      declineBtn.addEventListener('click', (e)=>{ e.stopPropagation(); updateStatus(item.id,'pending');  });
      withdrawBtn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        if(confirm('Diesen Eintrag wirklich löschen?')){
          await supabase.from('Database').update({status:'deleted'}).eq('id', item.id);
          const pin = localStorage.getItem('id'); if(pin) loadCards(pin);
        }
      });
      editBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openAdminForm(item); });

      feather.replace();
      return frag;
    }

    async function updateStatus(id,newStatus){
      const { error } = await supabase.from('Database').update({status:newStatus}).eq('id', id);
      if(!error){
        const pin = localStorage.getItem('id');
        if(pin) loadCards(pin);
      }
    }

    // ---------- Daten laden ----------
    // Store global data for toggling between views
    let _allFutureData = null;
    let _showingNotifications = false;

    // Global for bell shake interval
    let _bellShakeInterval = null;

    async function loadCards(pin){
      // Remove old cards
      // Remove pendingGrid and upcomingGrid content (legacy, but not used anymore visually)
      if (window.pendingGrid) pendingGrid.innerHTML = '';
      if (window.upcomingGrid) upcomingGrid.innerHTML = '';
      // Remove futureList content
      const futureList = document.getElementById('futureList');
      if (futureList) futureList.innerHTML = '';
      noPendingMsg.classList.add('hidden');

      let data, error;
      try{
        if((localStorage.getItem('role')||'user') === 'admin'){
          const res = await supabase.from('Database').select('*').eq('connected_user_A', pin);
          data = res.data; error = res.error;
        }else{
          const res = await supabase.from('Database').select('*').ilike('id', `${pin}_%`);
          data = res.data; error = res.error;
        }
      }catch(err){ error = err; }

      if(error){
        if (futureList) futureList.innerHTML = `<p style="color:#dc2626">Fehler beim Laden: ${error.message || error}</p>`;
        return;
      }
      if(!data || data.length===0){
        noPendingMsg.classList.add('hidden');
        return;
      }

      // Save all data for toggling logic
      _allFutureData = data;

      // Show noPendingMsg if no pending, hide otherwise
      const pending  = data.filter(d=>d.status==='pending');
      const approved = data.filter(d=>d.status==='approved');
      if(pending.length===0){ noPendingMsg.classList.add('hidden'); }

      // If currently showing notifications, re-render notifications, else approved
      if (_showingNotifications) {
        showNotifications(pending);
      } else {
        const sectionTitle = document.getElementById('futureSectionTitle');
        if (sectionTitle) sectionTitle.textContent = 'In Zukunft';
        const backButton = document.getElementById('backButton');
        if (backButton) backButton.style.display = 'none';
        if (futureList) {
          futureList.innerHTML = '';
          futureList.classList.add('fade-enter');
          const cards = await Promise.all(approved.map(item => createFutureCard(item)));
          cards.forEach(card => futureList.appendChild(card));
          requestAnimationFrame(() => {
            futureList.classList.add('fade-enter-active');
          });
          setTimeout(() => {
            futureList.classList.remove('fade-enter');
            futureList.classList.remove('fade-enter-active');
          }, 500);
        }
      }
      feather.replace();

      // ---- Glockenüberwachung für Pending-Elemente (Animation handled by monitorPendingStatus) ----
    }

    // ---------- Glockenüberwachung für Pending-Elemente ----------
    let _bellStatusInterval = null;

    async function monitorPendingStatus() {
      if (_bellStatusInterval) clearInterval(_bellStatusInterval);

      let _bellFirstRun = true;

      async function checkPendingStatus() {
        const pin = localStorage.getItem('id');
        if (!pin) {
          console.log("[BellCheck] Kein PIN gefunden, Glockenprüfung übersprungen.");
          return;
        }
        console.log(`[BellCheck] Überprüfung gestartet für PIN: ${pin}`);
        const { data, error } = await supabase
          .from('Database')
          .select('id')
          .ilike('id', `${pin}_%`)
          .eq('status', 'pending');
        console.log(`[BellCheck] Gefundene Pending-Elemente: ${data ? data.length : 0}`);

        const notificationsCard = document.getElementById('notificationsCard');
        if (!notificationsCard) {
          console.log("[BellCheck] notificationsCard nicht gefunden.");
          return;
        }
        const bellIcon = notificationsCard.querySelector('i[data-feather="bell"], svg.feather-bell');
        if (!bellIcon) {
          console.log("[BellCheck] Bell-Icon nicht gefunden.");
          return;
        }

        if (data && data.length > 0) {
          console.log("[BellCheck] Glocke morphs zu grünem Häkchen.");
          // Temporarily morph to a green checkmark with fade animation
          const bellParent = bellIcon.parentElement;
          if (bellParent) {
            bellParent.style.transition = 'opacity 0.4s ease';
            bellParent.style.opacity = '0';
            setTimeout(() => {
              bellParent.innerHTML = feather.icons['check'].toSvg({ width: 28, height: 28, color: '#16a34a' });
              bellParent.style.opacity = '1';
              setTimeout(() => {
                bellParent.style.opacity = '0';
                setTimeout(() => {
                  bellParent.innerHTML = feather.icons['bell'].toSvg({ width: 28, height: 28, color: '#000' });
                  bellParent.style.opacity = '1';
                  const newBell = bellParent.querySelector('svg');
                  if (newBell) {
                    newBell.classList.add('bell-shake');
                    setTimeout(() => newBell.classList.remove('bell-shake'), 1000);
                  }
                }, 400);
              }, 800);
            }, 400);
          }
        } else {
          console.log("[BellCheck] Keine Pending-Elemente gefunden. Glocke bleibt still.");
        }
      }

      // Initial und alle 10 Sekunden prüfen
      await checkPendingStatus();
      _bellStatusInterval = setInterval(() => {
        console.log("[BellCheck] Starte Glockenprüfung...");
        checkPendingStatus();
      }, 10000);
    }
    // Show Benachrichtigungen (pending) cards in futureList and update heading
    async function showNotifications(pending) {
      const sectionTitle = document.getElementById('futureSectionTitle');
      if (sectionTitle) sectionTitle.textContent = 'Erinnerungen';
      const futureList = document.getElementById('futureList');
      if (futureList) {
        futureList.innerHTML = '';
        futureList.classList.add('fade-enter');
        if (pending && pending.length > 0) {
          const cards = await Promise.all(pending.map(item => createFutureCard(item)));
          cards.forEach(card => futureList.appendChild(card));
        } else {
          // Optional: show message if no notifications
          const msg = document.createElement('div');
          msg.textContent = 'Keine Erinnerungen';
          msg.style.color = 'var(--muted)';
          msg.style.textAlign = 'center';
          msg.style.margin = '18px 0';
          futureList.appendChild(msg);
        }
        requestAnimationFrame(() => {
          futureList.classList.add('fade-enter-active');
        });
        setTimeout(() => {
          futureList.classList.remove('fade-enter');
          futureList.classList.remove('fade-enter-active');
        }, 500);
      }
      feather.replace();
    }


    // Create "In Zukunft" card for approved items - Transactions-style layout with initials, title, status, and toggleable description
    async function createFutureCard(item) {
      const tpl = document.createElement('div');
      tpl.className = 'future-list-card';
      tpl.style.cssText = `
        display:flex;
        align-items:center;
        justify-content:space-between;
        background:#fff;
        border:none;
        border-radius:0;
        box-shadow:none;
        padding:14px 0;
        gap:12px;
        cursor:pointer;
        flex-direction:column;
        border-bottom:1px solid #e5e7eb;
      `;

      // --- Outer row ---
      // Add gap for more spacing between initials and title
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;justify-content:space-between;width:100%;gap:16px;';

      // Left: Initials (date) box
      const initialsWrap = document.createElement('div');
      initialsWrap.style.cssText = `
        background:#000;
        border-radius:14px;
        width:42px;
        height:42px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:700;
        color:#fff;
        font-size:0.9rem;
        flex-shrink:0;
      `;

      let dateDisplay = '??';
      if (item.datum) {
        try {
          const dateObj = new Date(item.datum);
          if (!isNaN(dateObj)) {
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            dateDisplay = `${day}.${month}`;
          }
        } catch {}
      }
      initialsWrap.textContent = dateDisplay;

      // Middle: Bereich (title) and Typ (subtitle)
      const midWrap = document.createElement('div');
      midWrap.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:flex-start;';

      const titleEl = document.createElement('div');
      titleEl.textContent = item.bereich || 'Ohne Bereich';
      titleEl.style.cssText = 'font-weight:600;font-size:1.05rem;color:#000;';

      const subEl = document.createElement('div');
      subEl.textContent = item.typ || '';
      subEl.style.cssText = 'font-size:0.92rem;color:var(--muted);margin-top:2px;';

      midWrap.appendChild(titleEl);
      midWrap.appendChild(subEl);

      // Right: Status/value
      const statusEl = document.createElement('div');
      statusEl.style.cssText = 'font-weight:600;font-size:1rem;flex-shrink:0;';
      statusEl.textContent = '';

      row.appendChild(initialsWrap);
      row.appendChild(midWrap);
      row.appendChild(statusEl);

      // Add action buttons if in "Erinnerungen" (pending) section
      if (item.status === 'pending') {
        const actionWrap = document.createElement('div');
        actionWrap.style.cssText = 'display:flex;gap:14px;margin-left:auto;';

        const acceptBtn = document.createElement('button');
        acceptBtn.innerHTML = feather.icons['check-circle'].toSvg({ width: 22, height: 22 });
        acceptBtn.style.cssText = 'background:none;border:none;cursor:pointer;color:var(--success);';
        acceptBtn.title = 'Annehmen';
        acceptBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          await supabase.from('Database').update({ status: 'approved' }).eq('id', item.id);
          const pin = localStorage.getItem('id');
          if (pin) loadPendingCards();
        });

        const declineBtn = document.createElement('button');
        declineBtn.innerHTML = feather.icons['x-circle'].toSvg({ width: 22, height: 22 });
        declineBtn.style.cssText = 'background:none;border:none;cursor:pointer;color:var(--danger);';
        declineBtn.title = 'Ablehnen';
        declineBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          await supabase.from('Database').update({ status: 'declined' }).eq('id', item.id);
          const pin = localStorage.getItem('id');
          if (pin) loadPendingCards();
        });

        actionWrap.appendChild(acceptBtn);
        actionWrap.appendChild(declineBtn);
        row.appendChild(actionWrap);
      }

      // For admins: show edit button for declined containers
      const role = (localStorage.getItem('role') || 'user').toLowerCase();
      if (role === 'admin' && item.status === 'declined') {
        const actionWrap = document.createElement('div');
        actionWrap.style.cssText = 'display:flex;gap:14px;margin-left:auto;';

        const editBtn = document.createElement('button');
        editBtn.innerHTML = feather.icons['edit-3'].toSvg({ width: 22, height: 22 });
        editBtn.style.cssText = 'background:none;border:none;cursor:pointer;color:#000;';
        editBtn.title = 'Bearbeiten';
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          openAdminForm(item);
        });

        actionWrap.appendChild(editBtn);
        row.appendChild(actionWrap);
      }

      // Description (hidden initially)
      const desc = document.createElement('div');
      desc.textContent = item.beschreibung || 'Keine Beschreibung';
      desc.style.cssText = 'width:100%;color:var(--muted);font-size:0.9rem;margin-top:8px;display:none;';

      // Toggle description, closing others
      tpl.addEventListener('click', () => {
        const allCards = document.querySelectorAll('.future-list-card');
        allCards.forEach(c => {
          const d = c.querySelector('div[style*="color:var(--muted)"]');
          if (d && d !== desc) d.style.display = 'none';
        });
        desc.style.display = desc.style.display === 'none' ? 'block' : 'none';
      });

      tpl.appendChild(row);
      tpl.appendChild(desc);

      feather.replace();
      return tpl;
    }

    // ---------- Admin Helfer ----------
    async function loadUsers(){
      userGrid.innerHTML = '<p style="text-align:center;color:var(--muted)">Lade Benutzer…</p>';
      const {data, error} = await supabase.from('Database').select('UserName, id').not('id','is',null);
      if(error){ userGrid.innerHTML = `<p style="color:#dc2626">${error.message}</p>`; return; }
      userGrid.innerHTML='';
      const unique = [...new Map((data||[]).map(u=>[u.id,u])).values()];
      unique.forEach(u=>{
        const div = document.createElement('div');
        div.className = 'user-card';
        div.textContent = `${u.UserName} (${u.id})`;
        userGrid.appendChild(div);
      });
    }

    function addAdminButton(){
      if(document.querySelector('.edit-fab')) return;
      const fab = document.createElement('button');
      fab.className = 'btn-primary edit-fab';
      fab.style.position='fixed'; fab.style.right='22px'; fab.style.bottom='24px';
      fab.style.padding='12px 16px'; fab.style.borderRadius='14px'; fab.style.zIndex='40';
      fab.innerHTML = '<i data-feather="edit-3"></i>&nbsp;Eintrag';
      fab.onclick = ()=>openAdminForm();
      document.body.appendChild(fab);
      feather.replace();
      adminPanel.style.display='block';
      loadUsers();
    }

    async function openAdminForm(existing){
      if(document.getElementById('adminForm')) return;
      const wrap = document.createElement('div');
      wrap.id='adminForm';
      wrap.innerHTML = `
        <div style="position:fixed;inset:0;background:#0006;z-index:70" id="backdrop"></div>
        <div style="position:fixed;z-index:80;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;box-shadow:var(--shadow-lg);width:min(92vw,520px);padding:20px">
          <h3 style="margin:0 0 12px;font-weight:800">Dienst ${existing?'bearbeiten':'anlegen'}</h3>
          <label>Benutzer</label>
          <select id="userSelect" class="input" style="width:100%;margin-bottom:10px"></select>
          <label>Datum</label>
          <input id="datumInput" type="date" class="input" />
          <label>Typ</label>
          <input id="typInput" class="input" placeholder="Typ" />
          <label>Bereich</label>
          <input id="bereichInput" class="input" placeholder="Bereich" />
          <label>Beschreibung</label>
          <textarea id="beschreibungInput" class="input" placeholder="Beschreibung" rows="3"></textarea>
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
            <button id="cancelNew" class="chip-btn">Abbrechen</button>
            <button id="saveNew" class="btn-primary">${existing?'Änderungen speichern':'Speichern'}</button>
          </div>
        </div>`;
      document.body.appendChild(wrap);

      const {data: users} = await supabase.from('Database').select('UserName,id').not('id','is',null);
      const filtered = (users||[]).filter(u=>u.id && u.id.length===4);
      const sel = document.getElementById('userSelect');
      ([...new Map(filtered.map(u=>[u.id,u])).values()]).forEach(u=>{
        const opt=document.createElement('option'); opt.value=u.id; opt.textContent=`${u.UserName} (${u.id})`; sel.appendChild(opt);
      });

      if(existing){
        document.getElementById('datumInput').value = existing.datum || '';
        document.getElementById('typInput').value = existing.typ || '';
        document.getElementById('bereichInput').value = existing.bereich || '';
        document.getElementById('beschreibungInput').value = existing.beschreibung || '';
        document.getElementById('saveNew').dataset.editId = existing.id;
      }

      const close = ()=>wrap.remove();
      document.getElementById('backdrop').onclick = close;
      document.getElementById('cancelNew').onclick = close;

      document.getElementById('saveNew').onclick = async ()=>{
        const userId = sel.value;
        const datum = document.getElementById('datumInput').value;
        const typ   = document.getElementById('typInput').value.trim();
        const bereich = document.getElementById('bereichInput').value.trim();
        const beschreibung = document.getElementById('beschreibungInput').value.trim();
        if(!userId || !datum || !typ || !bereich || !beschreibung) return;

        const btn = document.getElementById('saveNew');
        if(btn.dataset.editId){
          await supabase.from('Database').update({
            datum,
            typ,
            bereich,
            beschreibung,
            status: 'pending'
          }).eq('id', btn.dataset.editId);
        }else{
          const creatorPin = localStorage.getItem('id');
          let creatorName = 'Unbekannt';
          const {data:cData} = await supabase.from('Database').select('UserName').eq('id', creatorPin).single();
          if(cData && cData.UserName) creatorName = cData.UserName;
          const randomPart = Math.floor(100000 + Math.random()*900000);
          const id = `${userId}_${randomPart}`;
          await supabase.from('Database').insert([{
            id,
            datum,
            typ,
            bereich,
            beschreibung,
            connected_user_A: creatorPin,
            connected_user_B: userId,
            UserName: creatorName,
            status: 'pending'
          }]);
        }
        close();
        const pin=localStorage.getItem('id'); if(pin) loadCards(pin);
      };
    }


    // ---------- Login ----------
    document.getElementById('loginBtn').addEventListener('click', async ()=>{
      const pin = (document.getElementById('pinInput').value || '').trim();
      const err = document.getElementById('loginError');
      if(pin.length!==4){ err.style.display='block'; return; }
      err.style.display='none';

      // Tabelle "Database" ist die Usersource für die PIN
      const {data:userData, error} = await supabase.from('Database').select('*').eq('id', pin).limit(1);
      if(error || !userData || userData.length===0){ err.style.display='block'; return; }

      const user = userData[0];
      localStorage.setItem('id', pin);
      localStorage.setItem('role', user.role || 'user');
      localStorage.setItem('userColors', JSON.stringify({
        fach: user.color_f || '#3A6FF8',
        pers: user.color_p || '#16a34a',
        sozial: user.color_s || '#f59e0b'
      }));
      document.cookie = `lilly_pin=${pin}; path=/; max-age=${60*60*24*30}; SameSite=Lax`;
      console.log("[Login] Cookie gespeichert für PIN:", pin);

      // Update userMainName under avatar
      const userMainName = document.getElementById('userMainName');
      if (userMainName && user.UserName) {
        userMainName.textContent = user.UserName;
      }
      // Avatar SVG rendering
      const avatarContainer = document.querySelector('#appMain div[style*="width:96px"]');
      if (avatarContainer && user.user_profile_pic && profileSVGs[user.user_profile_pic]) {
        avatarContainer.innerHTML = profileSVGs[user.user_profile_pic];
      } else if (avatarContainer) {
        avatarContainer.innerHTML = profileSVGs['avatar01'];
      }

      // UI umschalten
      loginScreen.style.display = 'none';
      // appHeader.style.display = 'block'; // removed header
      appMain.classList.remove('hidden');

      // Admin
      if((user.role||'user') === 'admin'){ addAdminButton(); } else { const fab=document.querySelector('.edit-fab'); if(fab) fab.remove(); adminPanel.style.display='none'; }

      // Daten laden
      await loadCards(pin);
      monitorPendingStatus();

      // Realtime (Database)
      let reloadTimeout;
      supabase.channel('live-updates')
        .on('postgres_changes', {event:'*', schema:'public', table:'Database'},
          async (payload)=>{
            if(reloadTimeout) clearTimeout(reloadTimeout);
            reloadTimeout = setTimeout(async ()=>{
              const currentPin = localStorage.getItem('id');
              if(currentPin) await loadCards(currentPin);
            }, 400);
          })
        .subscribe();
    });

    // Enter auf PIN
    document.getElementById('pinInput').addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); document.getElementById('loginBtn').click(); }
    });

    // Begrüßungstext in der Sprechblase zufällig wählen
    const greetings = [
      "Schön, dich zu sehen!",
      "Willkommen zurück!",
      "Bereit für deinen Tag?",
      "Hey, alles klar?",
      "Los geht's!",
      "Heute wird dein Tag!",
      "Zeit für ein bisschen Magie!",
      "Miau – du bist wieder da!",
      "Deine Aufgaben warten schon!",
      "Lilly ist stolz auf dich!"
    ];
    const bubble = document.getElementById('catSpeech');
    if (bubble) {
      bubble.textContent = greetings[Math.floor(Math.random() * greetings.length)];
    }

  </script>
  <script>
    // SkillMeter JS

    // --- SkillMeter: Fetch Explanation Function ---
    async function fetchExplanation(skillKey) {
      try {
        const response = await fetch("https://default7a0df6a535c94bdcae489c981a4d55.59.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/3bee0f15b43e4ac19b3b404254439485/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vOU4h2a-y-UI36FgHwFafyaMWP2tFGV6Pbjw8_Ij8bo", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ skill: skillKey })
        });
        if (!response.ok) throw new Error(`HTTP-Fehler: ${response.status}`);
        const result = await response.json();
        return result.text || JSON.stringify(result);
      } catch (err) {
        console.error("Fehler beim Abrufen der Erklärung:", err);
        return "Beim Laden der Erklärung ist ein Fehler aufgetreten.";
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const bars = document.querySelectorAll('#skillMeter .skill-bar .fill');
      // Set transition property for animation
      bars.forEach(bar => {
        bar.style.transition = 'width 1s ease-out';
        bar.style.width = '0%';
      });

      // Farben aus Supabase holen & in localStorage speichern
      let userColors = {};
      const userId = localStorage.getItem('id');
      if (userId) {
        try {
          // Farben aus Supabase laden
          const { data, error } = await supabase
            .from('Database')
            .select('color_f, color_p, color_s')
            .eq('id', userId)
            .single();
          userColors = {
            fach: (data && data.color_f) || '#3A6FF8',
            pers: (data && data.color_p) || '#16a34a',
            sozial: (data && data.color_s) || '#f59e0b'
          };
          // In localStorage speichern
          localStorage.setItem('userColors', JSON.stringify(userColors));
        } catch (err) {
          userColors = {
            fach: '#3A6FF8',
            pers: '#16a34a',
            sozial: '#f59e0b'
          };
        }
      } else {
        // Try localStorage fallback
        try {
          const stored = JSON.parse(localStorage.getItem('userColors') || '{}');
          userColors = {
            fach: stored.fach || '#3A6FF8',
            pers: stored.pers || '#16a34a',
            sozial: stored.sozial || '#f59e0b'
          };
        } catch {
          userColors = {
            fach: '#3A6FF8',
            pers: '#16a34a',
            sozial: '#f59e0b'
          };
        }
      }

      // Apply user colors to the bars immediately before any animation
      bars.forEach(bar => {
        // Determine skill type by parent .skill-bar's data-skill
        const skillBar = bar.parentElement && bar.parentElement.dataset ? bar.parentElement.dataset.skill : null;
        if (skillBar === 'fach') bar.style.background = userColors.fach || '#3A6FF8';
        if (skillBar === 'pers') bar.style.background = userColors.pers || '#16a34a';
        if (skillBar === 'sozial') bar.style.background = userColors.sozial || '#f59e0b';
      });

      // Animate bars from 0% to calculated width after a short delay
      setTimeout(() => {
        bars.forEach(bar => {
          const level = Math.floor(Math.random() * 4) + 1;
          const width = level * 25;
          bar.style.width = width + '%';
        });
      }, 80);

      // --- Skill Detail logic ---
      const skillDetail = document.getElementById('skillDetail');
      const skillTitle = document.getElementById('skillTitle');
      const skillText = document.getElementById('skillText');
      const triangle = skillDetail.querySelector('.triangle');

      const skillMap = {
        fach: 'Fachkompetenz',
        pers: 'Persönlichkeitskompetenz',
        sozial: 'Sozialkompetenz'
      };

      document.querySelectorAll('#skillMeter .skill-bar').forEach((bar, index) => {
        bar.addEventListener('click', async (e) => {
          const key = bar.dataset.skill;
          const isVisible = skillDetail.style.display === 'block';

          if (isVisible && skillTitle.textContent === skillMap[key]) {
            skillDetail.classList.remove('ripple-open');
            skillDetail.classList.add('ripple-close');
            setTimeout(() => {
              skillDetail.style.display = 'none';
              skillDetail.classList.remove('ripple-close');
              // Shift future section back up
              const futureSection = document.querySelector('.app-section');
              if (futureSection) {
                futureSection.classList.remove('active');
              }
            }, 280);
            return;
          }

          const rect = bar.getBoundingClientRect();
          const parentRect = bar.parentElement.getBoundingClientRect();
          const centerX = rect.left - parentRect.left + rect.width / 2;
          triangle.style.left = `${centerX}px`;

          skillTitle.textContent = skillMap[key] || 'Kompetenz';
          const explanation = await fetchExplanation(key);
          skillText.textContent = explanation;

          // Set circle color according to skill and userColors
          const colorMap = {
            fach: userColors.fach || '#3A6FF8',
            pers: userColors.pers || '#16a34a',
            sozial: userColors.sozial || '#f59e0b'
          };
          const circle = document.getElementById('skillColorCircle');
          if (circle) {
            circle.style.background = colorMap[key];
          }
          // Update the corresponding bar (.fill) color as well
          const barFill = bar.querySelector('.fill');
          if (barFill) barFill.style.background = colorMap[key];

          skillDetail.style.display = 'block';
          // Shift future section down
          const futureSection = document.querySelector('.app-section');
          if (futureSection) {
            futureSection.classList.add('shift-down', 'active');
          }
          skillDetail.classList.remove('ripple-close');
          skillDetail.classList.add('ripple-open');
          feather.replace();
        });
      });

      // ========== Color Palette Feature ==========
      const colorCircle = document.getElementById('skillColorCircle');
      const colorPalette = document.getElementById('colorPalette');
      let activeSkill = null;

      // Toggle color palette when clicking on main circle
      colorCircle.addEventListener('click', (e) => {
        e.stopPropagation();
        colorPalette.style.display = (colorPalette.style.display === 'flex') ? 'none' : 'flex';
      });

      // Hide palette when clicking elsewhere
      document.addEventListener('click', (e) => {
        if (!colorPalette.contains(e.target) && e.target !== colorCircle) {
          colorPalette.style.display = 'none';
        }
      });

      // Apply new color when selecting a color option
      colorPalette.querySelectorAll('.color-option').forEach(opt => {
        opt.addEventListener('click', async () => {
          const newColor = opt.dataset.color;
          if (!activeSkill) return;

          // Update circle and bar color
          colorCircle.style.background = newColor;
          const bar = document.querySelector(`.skill-bar[data-skill="${activeSkill}"] .fill`);
          if (bar) bar.style.background = newColor;

          // Update local storage
          const userColors = JSON.parse(localStorage.getItem('userColors') || '{}');
          userColors[activeSkill] = newColor;
          localStorage.setItem('userColors', JSON.stringify(userColors));

          // Speichern in Supabase
          const userId = localStorage.getItem('id');
          if (userId) {
            const columnMap = {
              fach: 'color_f',
              pers: 'color_p',
              sozial: 'color_s'
            };
            const column = columnMap[activeSkill];
            if (column) {
              const { error } = await supabase
                .from('Database')
                .update({ [column]: newColor })
                .eq('id', userId);
              if (error) console.error('Fehler beim Speichern der Farbe:', error);
            }
          }

          colorPalette.style.display = 'none';
        });
      });

      // Track which skill is currently active
      document.querySelectorAll('#skillMeter .skill-bar').forEach(bar => {
        bar.addEventListener('click', () => {
          activeSkill = bar.dataset.skill;
        });
      });
      // ========== End Color Palette Feature ==========
    });
  </script>
</body>
</html>

  <style>
  .scroll-gallery::-webkit-scrollbar { display:none; }
  .scroll-gallery { scrollbar-width:none; }
  .scroll-gallery-wrapper {
    position: relative;
    width: 100%;
    max-width: var(--container);
    overflow: hidden;
  }
  .scroll-btn-bar {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-bottom: 6px;
  }
  .scroll-btn {
    background: none;
    border: none;
    border-radius: 0;
    width: 28px;
    height: 28px;
    color: var(--text);
    opacity: 0.7;
    cursor: pointer;
    transition: opacity .2s;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  .scroll-btn:hover { opacity: 1; }
  @media (min-width: 720px) {
    .scroll-btn-bar { display: none; }
  }
  </style>

  <script>
    // Scroll buttons for scroll-gallery
    document.querySelectorAll('.scroll-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const gallery = document.querySelector('.scroll-gallery');
        const scrollAmount = 200;
        if (btn.classList.contains('left')) {
          gallery.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        } else {
          gallery.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
      });
    });

    // ---------- Erinnerungen Card Toggle ----------
    // Track if notifications are currently being shown
    function setupNotificationsToggle() {
      const notificationsCard = document.getElementById('notificationsCard');
      if (!notificationsCard) return;
      notificationsCard.addEventListener('click', async () => {
        if (_showingNotifications) return; // prevent multiple triggers
        _showingNotifications = true;
        // Dim other gallery elements
        const cards = document.querySelectorAll('.scroll-gallery > div');
        cards.forEach(c => c.style.opacity = (c === notificationsCard ? '1' : '0.5'));
        await loadPendingCards();
      });
    }

    // ---------- Einstellungen Card Toggle ----------
    function setupSettingsToggle() {
      // Find the settings card (the one with SVG feather-settings icon)
      const settingsCard = Array.from(document.querySelectorAll('.scroll-gallery > div')).find(card =>
        card.querySelector('svg.feather-settings')
      );
      if (!settingsCard) {
        console.warn("Settings-Card nicht gefunden");
        return;
      }

      const futureList = document.getElementById('futureList');
      const sectionTitle = document.getElementById('futureSectionTitle');
      const backButton = document.getElementById('backButton');
      let settingsMode = false;

      // Utility: fade out all cards except settingsCard
      function fadeGalleryCards() {
        const cards = document.querySelectorAll('.scroll-gallery > div');
        cards.forEach(c => c.style.opacity = (c === settingsCard ? '1' : '0.5'));
      }
      function resetGalleryCards() {
        const cards = document.querySelectorAll('.scroll-gallery > div');
        cards.forEach(c => {
          c.style.transition = 'opacity 0.5s ease';
          c.style.opacity = '1';
        });
      }

      // Utility: clear settings view and restore main
      async function exitSettingsMode() {
        settingsMode = false;
        if (sectionTitle) sectionTitle.textContent = 'In Zukunft';
        if (backButton) backButton.style.display = 'none';
        if (futureList) {
          const pin = localStorage.getItem('id');
          if (pin) await loadCards(pin);
        }
        resetGalleryCards();
      }

      // --- Name ändern ---
      function renderNameChange(user) {
        if (!futureList) return;
        futureList.innerHTML = '';
        const wrap = document.createElement('div');
        wrap.style = 'display:flex;flex-direction:column;gap:18px;align-items:flex-start;padding-top:14px;';
        const label = document.createElement('label');
        label.textContent = 'Neuer Name';
        label.style = 'font-weight:600;margin-bottom:4px;';
        const input = document.createElement('input');
        input.className = 'input';
        input.type = 'text';
        input.value = user.UserName || '';
        input.maxLength = 30;
        input.style = 'font-size:1rem;width:100%;margin-bottom:8px;';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn-primary';
        saveBtn.textContent = 'Speichern';
        saveBtn.style = 'margin-top:4px;';
        const statusMsg = document.createElement('div');
        statusMsg.style = 'font-size:0.97rem;margin-top:8px;';
        wrap.appendChild(label);
        wrap.appendChild(input);
        wrap.appendChild(saveBtn);
        wrap.appendChild(statusMsg);
        futureList.appendChild(wrap);
        saveBtn.addEventListener('click', async () => {
          const name = input.value.trim();
          if (!name) {
            statusMsg.textContent = 'Name darf nicht leer sein.';
            statusMsg.style.color = 'var(--danger)';
            return;
          }
          saveBtn.disabled = true;
          const {error} = await supabase.from('Database').update({UserName: name}).eq('id', user.id);
          if (!error) {
            statusMsg.textContent = 'Gespeichert!';
            statusMsg.style.color = 'var(--success)';
            // Update name in UI
            const userMainName = document.getElementById('userMainName');
            if (userMainName) userMainName.textContent = name;
            // Nach kurzer Verzögerung wieder das Einstellungsmenü anzeigen
            setTimeout(() => renderSettingsMenu(user), 800);
          } else {
            statusMsg.textContent = 'Fehler beim Speichern.';
            statusMsg.style.color = 'var(--danger)';
          }
          saveBtn.disabled = false;
        });
      }

      // --- Avatar auswählen ---
      function renderAvatarSelect(user) {
        if (!futureList) return;
        futureList.innerHTML = '';
        const wrap = document.createElement('div');
        wrap.style = 'display:flex;flex-direction:column;gap:20px;align-items:flex-start;padding-top:10px;';
        const label = document.createElement('div');
        label.textContent = 'Avatar auswählen';
        label.style = 'font-weight:600;margin-bottom:6px;';
        // Avatars grid
        const grid = document.createElement('div');
        grid.style = 'display:grid;grid-template-columns:repeat(5,54px);gap:14px;';
        Object.entries(profileSVGs).forEach(([key, svg]) => {
          const btn = document.createElement('button');
          btn.style = 'background:none;border:2px solid #e5e7eb;border-radius:16px;padding:3px;width:54px;height:54px;cursor:pointer;transition:border-color .2s;';
          btn.innerHTML = svg;
          if (user.user_profile_pic === key) {
            btn.style.borderColor = 'var(--accent)';
            btn.style.boxShadow = '0 0 0 2px var(--accent)';
          }
          btn.addEventListener('click', async () => {
            // Save to Supabase
            const {error} = await supabase.from('Database').update({user_profile_pic: key}).eq('id', user.id);
            if (!error) {
              // Update avatar in UI
              const avatarContainer = document.querySelector('#appMain div[style*="width:96px"]');
              if (avatarContainer) avatarContainer.innerHTML = svg;
              // Mark selected
              Array.from(grid.children).forEach(b => b.style.borderColor = '#e5e7eb');
              btn.style.borderColor = 'var(--accent)';
              statusMsg.textContent = 'Avatar aktualisiert!';
              statusMsg.style.color = 'var(--success)';
              // Nach kurzer Verzögerung wieder das Einstellungsmenü anzeigen
              setTimeout(() => renderSettingsMenu(user), 800);
            } else {
              statusMsg.textContent = 'Fehler beim Speichern.';
              statusMsg.style.color = 'var(--danger)';
            }
          });
          grid.appendChild(btn);
        });
        const statusMsg = document.createElement('div');
        statusMsg.style = 'font-size:0.97rem;margin-top:10px;';
        wrap.appendChild(label);
        wrap.appendChild(grid);
        wrap.appendChild(statusMsg);
        futureList.appendChild(wrap);
      }

      // --- Konto löschen ---
      function renderDeleteAccount(user) {
        if (!futureList) return;
        futureList.innerHTML = '';
        const wrap = document.createElement('div');
        wrap.style = 'display:flex;flex-direction:column;gap:18px;align-items:flex-start;padding-top:16px;';
        const warn = document.createElement('div');
        warn.textContent = 'Bist du sicher? Dein Konto wird unwiderruflich gelöscht.';
        warn.style = 'color:var(--danger);font-weight:600;margin-bottom:8px;';
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-primary';
        delBtn.textContent = 'Konto löschen';
        delBtn.style = 'background:var(--danger);border-color:var(--danger);color:#fff;';
        const statusMsg = document.createElement('div');
        statusMsg.style = 'font-size:0.97rem;margin-top:10px;';
        wrap.appendChild(warn);
        wrap.appendChild(delBtn);
        wrap.appendChild(statusMsg);
        futureList.appendChild(wrap);
        delBtn.addEventListener('click', async () => {
          if (!confirm('Willst du dein Konto wirklich löschen? Dies kann nicht rückgängig gemacht werden.')) return;
          delBtn.disabled = true;
          // Delete user from Supabase
          const {error} = await supabase.from('Database').delete().eq('id', user.id);
          if (!error) {
            // Clear localStorage and redirect to login
            localStorage.clear();
            document.cookie = 'lilly_pin=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax';
            statusMsg.textContent = 'Konto gelöscht. Du wirst abgemeldet...';
            statusMsg.style.color = 'var(--success)';
            setTimeout(() => {
              window.location.reload();
            }, 1200);
          } else {
            statusMsg.textContent = 'Fehler beim Löschen.';
            statusMsg.style.color = 'var(--danger)';
            delBtn.disabled = false;
          }
        });
      }

      // Main settings menu
      function renderSettingsMenu(user) {
        if (!futureList) return;
        futureList.innerHTML = '';
        const wrap = document.createElement('div');
        wrap.style = 'display:flex;flex-direction:column;gap:22px;align-items:flex-start;padding-top:10px;';
        // Option: Name ändern
        const nameBtn = document.createElement('button');
        nameBtn.className = 'chip-btn';
        nameBtn.textContent = 'Name ändern';
        nameBtn.style = 'font-size:1.08rem;font-weight:600;';
        nameBtn.addEventListener('click', () => renderNameChange(user));
        // Option: Avatar auswählen
        const avatarBtn = document.createElement('button');
        avatarBtn.className = 'chip-btn';
        avatarBtn.textContent = 'Avatar auswählen';
        avatarBtn.style = 'font-size:1.08rem;font-weight:600;';
        avatarBtn.addEventListener('click', () => renderAvatarSelect(user));
        // Option: Konto löschen
        const delBtn = document.createElement('button');
        delBtn.className = 'chip-btn';
        delBtn.textContent = 'Konto löschen';
        delBtn.style = 'font-size:1.08rem;font-weight:600;color:var(--danger);';
        delBtn.addEventListener('click', () => renderDeleteAccount(user));
        wrap.appendChild(nameBtn);
        wrap.appendChild(avatarBtn);
        wrap.appendChild(delBtn);
        // Option: Konto hinzufügen (nur für Admin)
        const role = (localStorage.getItem('role') || 'user').toLowerCase();
        if (role === 'admin') {
          const addBtn = document.createElement('button');
          addBtn.className = 'chip-btn';
          addBtn.textContent = 'Konto hinzufügen';
          addBtn.style = 'font-size:1.08rem;font-weight:600;color:var(--accent);';
          addBtn.addEventListener('click', async () => {
            const newId = Math.floor(1000 + Math.random() * 9000).toString();
            const newName = prompt('Bitte gib einen Namen für das neue Konto ein:', 'Neuer Benutzer');
            if (!newName) {
              alert('Vorgang abgebrochen – kein Name angegeben.');
              return;
            }
            const { error } = await supabase.from('Database').insert([{ id: newId, UserName: newName.trim(), role: 'user' }]);
            if (!error) {
              alert(`Neues Konto erstellt:\nID: ${newId}\nName: ${newName}`);
            } else {
              alert('Fehler beim Erstellen des neuen Kontos.');
            }
          });
          wrap.appendChild(addBtn);
        }
        futureList.appendChild(wrap);
      }

      settingsCard.addEventListener('click', async () => {
        if (settingsMode) return;
        settingsMode = true;
        fadeGalleryCards();
        if (sectionTitle) sectionTitle.textContent = 'Was möchtest du ändern?';
        if (backButton) backButton.style.display = 'inline';
        // Load user data
        const pin = localStorage.getItem('id');
        if (!pin) return;
        const {data, error} = await supabase.from('Database').select('*').eq('id', pin).single();
        if (error || !data) {
          if (futureList) futureList.innerHTML = '<div style="color:var(--danger);margin-top:14px;">Fehler beim Laden der Einstellungen.</div>';
          return;
        }
        renderSettingsMenu(data);
      });

      // Back button returns from settings
      if (backButton) {
        backButton.addEventListener('click', async () => {
          if (!settingsMode) return;
          await exitSettingsMode();
        });
      }
    }

    // Lädt alle pending cards für den eingeloggten User und rendert sie
    async function loadPendingCards() {
      const pin = localStorage.getItem('id');
      if (!pin) return;
      let data, error;
      const role = (localStorage.getItem('role') || 'user').toLowerCase();

      try {
        if (role === 'admin') {
          ({ data, error } = await supabase
            .from('Database')
            .select('*')
            .eq('status', 'declined'));
        } else {
          ({ data, error } = await supabase
            .from('Database')
            .select('*')
            .ilike('id', `${pin}_%`)
            .eq('status', 'pending'));

          if (!data || data.length === 0) {
            const res2 = await supabase
              .from('Database')
              .select('*')
              .eq('connected_user_A', pin)
              .eq('status', 'pending');
            if (res2.data && res2.data.length > 0) {
              data = res2.data;
            }
          }
        }
      } catch (err) { error = err; }

      const sectionTitle = document.getElementById('futureSectionTitle');
      const futureList = document.getElementById('futureList');
      if (sectionTitle) sectionTitle.textContent = (role === 'admin') ? 'Erinnerungen' : 'Benachrichtigungen';
      const backButton = document.getElementById('backButton');
      if (backButton) backButton.style.display = 'inline';

      if (futureList) {
        futureList.innerHTML = '';
        futureList.classList.add('fade-enter');

        if (error) {
          const msg = document.createElement('div');
          msg.textContent = 'Fehler beim Laden.';
          msg.style.color = 'var(--danger)';
          msg.style.textAlign = 'center';
          futureList.appendChild(msg);
        } else {
          // Nur Nachricht anzeigen, wenn wirklich keine Karten vorhanden sind
          if (!data || data.length === 0) {
            const msg = document.createElement('div');
            msg.textContent = (role === 'admin') ? 'Keine abgelehnten Einträge.' : 'Keine Benachrichtigungen.';
            msg.style.color = 'var(--muted)';
            msg.style.textAlign = 'center';
            msg.style.margin = '18px 0';
            futureList.appendChild(msg);
          } else {
            const cards = await Promise.all(data.map(item => createFutureCard(item)));
            cards.forEach(card => futureList.appendChild(card));
          }
        }

        requestAnimationFrame(() => {
          futureList.classList.add('fade-enter-active');
        });
        setTimeout(() => {
          futureList.classList.remove('fade-enter');
          futureList.classList.remove('fade-enter-active');
        }, 500);
      }

      feather.replace();
    }

    // ---------- Back Button Initialization ----------
    document.addEventListener('DOMContentLoaded', () => {
      const backButton = document.getElementById('backButton');
      if (backButton) {
        backButton.addEventListener('click', async () => {
          _showingNotifications = false;
          const sectionTitle = document.getElementById('futureSectionTitle');
          const pin = localStorage.getItem('id');
          if (sectionTitle) sectionTitle.textContent = 'In Zukunft';
          backButton.style.display = 'none';
          if (pin) await loadCards(pin);
          // Reset all gallery card opacities to 1 with fade transition
          const cards = document.querySelectorAll('.scroll-gallery > div');
          cards.forEach(c => {
            c.style.transition = 'opacity 0.5s ease';
            c.style.opacity = '1';
          });
        });
      }
    });
 
 

// ---------- Add Container Button ----------
document.addEventListener('DOMContentLoaded', () => {
  const addBtn = document.getElementById('addContainerBtn');
  if (addBtn) {
    addBtn.addEventListener('click', () => {
      openAdminForm();
    });
  }
});

// ---------- Logout Button ----------
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', () => {
    console.log('[Logout] Button clicked – clearing storage and redirecting...');
    localStorage.clear();
    document.cookie = 'lilly_pin=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax';
    window.location.href = "https://lillyapp.github.io/lillyapp";
  });
}
      </script>
